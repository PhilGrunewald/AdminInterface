<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>interface &#8212; MeterInterface beta documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../README.html">MeterInterface beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for interface</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>

<span class="c1"># Shortcuts:</span>
<span class="c1"># -----------</span>
<span class="c1">#   #action_keys        single key commands</span>
<span class="c1">#   #menu_text          main screen text</span>
<span class="c1">#   #menu_bar           the pop up menu</span>
<span class="c1">#   #display_data       display data depending on displayModus</span>
<span class="c1">#   #action_highlighted action based on line selected (enter) depending on displayModus</span>
<span class="c1">#   #statusUpdate       list of and setting of household status</span>

<span class="c1"># ADB comands worth integrating</span>
<span class="c1"># Check AUTOSTART setting</span>
<span class="c1"># adb shell dumpsys | grep -A 2 &quot;power off alarms dump&quot;</span>
<span class="c1"># Check Battery level</span>
<span class="c1"># Android 4</span>
<span class="c1"># adb shell dumpsys battery | grep level</span>
<span class="c1"># Android 6</span>

<span class="c1"># adb shell am force-stop org.energy_use.meter</span>
<span class="c1"># What apps are running</span>
<span class="c1"># adb shell ps</span>

<span class="c1"># For plotting</span>
<span class="kn">import</span> <span class="nn">json</span>                   <span class="c1"># used for reading activities.json</span>
<span class="c1"># import numpy as np          # used for mean</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>           <span class="c1"># to reshape el readings</span>
<span class="kn">import</span> <span class="nn">textwrap</span>               <span class="c1"># to wrap long comments</span>

<span class="kn">from</span> <span class="nn">meter</span> <span class="k">import</span> <span class="o">*</span>         <span class="c1"># db connection and npyscreen features</span>
<span class="kn">import</span> <span class="nn">meter_ini</span>     <span class="c1"># reads the database and file path information</span>

<span class="n">Criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Home&#39;</span><span class="p">:</span>         <span class="s1">&#39;status &gt;= 0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Upcoming&#39;</span><span class="p">:</span>     <span class="s1">&#39;status &lt; 4 AND date_choice &gt;= CURDATE() AND date_choice &lt; CURDATE() + INTERVAL &quot;31&quot; DAY ORDER BY date_choice ASC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Confirmed&#39;</span><span class="p">:</span>    <span class="s1">&#39;status = 4 ORDER BY date_choice ASC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Issued&#39;</span><span class="p">:</span>       <span class="s1">&#39;status = 5 ORDER BY date_choice ASC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Processed&#39;</span><span class="p">:</span>    <span class="s1">&#39;status &gt; 5 ORDER BY date_choice DESC&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Future&#39;</span><span class="p">:</span>       <span class="s1">&#39;date_choice &gt; CURDATE()&#39;</span><span class="p">,</span>
            <span class="s1">&#39;No date yet&#39;</span><span class="p">:</span>  <span class="s1">&#39;date_choice &lt; &quot;2010-01-01&quot;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;no reading&#39;</span><span class="p">:</span>   <span class="s1">&#39;Watt &lt; 10&#39;</span><span class="p">,</span>
            <span class="s1">&#39;high reading&#39;</span><span class="p">:</span> <span class="s1">&#39;Watt &gt; 500&#39;</span>
            <span class="p">}</span>

<span class="n">Screen</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ActionKeys</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">ScreenKey</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
<span class="n">householdID</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

<span class="n">first_time</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">showHouseholds</span><span class="p">():</span>
    <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s1">&#39;Households&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="callShell"><a class="viewcode-back" href="../README.html#interface.callShell">[docs]</a><span class="k">def</span> <span class="nf">callShell</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; executes shell command and returns all text displayed &quot;&quot;&quot;</span>
    <span class="n">call</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &gt; .temp&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">messageStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;.temp&#39;</span><span class="p">):</span>
        <span class="n">messageStr</span> <span class="o">+=</span> <span class="n">line</span>
    <span class="k">return</span> <span class="n">messageStr</span></div>

<div class="viewcode-block" id="getDateTimeNow"><a class="viewcode-back" href="../README.html#interface.getDateTimeNow">[docs]</a><span class="k">def</span> <span class="nf">getDateTimeNow</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; current date and time in format &quot;YYYY-MM-DD hh:mm:ss&quot; &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span></div>

<div class="viewcode-block" id="showScreen"><a class="viewcode-back" href="../README.html#interface.showScreen">[docs]</a><span class="k">def</span> <span class="nf">showScreen</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; populate screen based ScreenKey dict &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">ScreenKey</span>
    <span class="k">global</span> <span class="n">householdID</span>
    <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Household&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">householdID</span>
    <span class="n">ScreenKey</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">householdID</span> <span class="o">=</span> <span class="n">Screen</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">][</span><span class="s1">&#39;Household&#39;</span><span class="p">]</span>
    <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span></div>


<div class="viewcode-block" id="getDateOfFirstEntry"><a class="viewcode-back" href="../README.html#interface.getDateOfFirstEntry">[docs]</a><span class="k">def</span> <span class="nf">getDateOfFirstEntry</span><span class="p">(</span><span class="n">thisFile</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Find the date string in a data file &quot;&quot;&quot;</span>
    <span class="c1"># expected format: ...,2016-02-22T17:00:00.000Z,...</span>
    <span class="c1"># in the second column</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">thisFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">firstLine</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">dateTime</span> <span class="o">=</span> <span class="n">firstLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span>
    <span class="n">thisDate</span> <span class="o">=</span> <span class="n">dateTime</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">thisDate</span></div>


<div class="viewcode-block" id="getMetaData"><a class="viewcode-back" href="../README.html#interface.getMetaData">[docs]</a><span class="k">def</span> <span class="nf">getMetaData</span><span class="p">(</span><span class="n">MetaFile</span><span class="p">,</span> <span class="n">ItemName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; extract content from meta file (or any other file) &quot;&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">MetaFile</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ItemName</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ItemName</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>


<div class="viewcode-block" id="data_download"><a class="viewcode-back" href="../README.html#interface.data_download">[docs]</a><span class="k">def</span> <span class="nf">data_download</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; pull files from phone &quot;&quot;&quot;</span>
    <span class="c1"># 7 Nov 2016: previously downloaded &#39;files&#39; to filepath</span>
    <span class="c1"># Android 6(?) causes the &#39;METER folder&#39; to be placed in filePath</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb pull /sdcard/METER/ &#39;</span> <span class="o">+</span> <span class="n">filePath</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;adb shell ls /sdcard/Meter/&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="c1"># message(&quot;%s&quot;%s)</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb shell rm -rf /sdcard/Meter/*.csv&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb shell rm -rf /sdcard/Meter/*.json&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb shell rm -rf /sdcard/Meter/*.meta&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">updateIDfile</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>  <span class="c1"># set to 0 to ignore if phone comes on again</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;MetaForm&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span><span class="p">(</span><span class="s2">&quot;No device detected&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">data_review</span><span class="p">():</span>
    <span class="n">MeterApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;MetaForm&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="get_time_period"><a class="viewcode-back" href="../README.html#interface.get_time_period">[docs]</a><span class="k">def</span> <span class="nf">get_time_period</span><span class="p">(</span><span class="n">timestr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; convert into one of 144 10minute periods of the day &quot;&quot;&quot;</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.00167</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">timestr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)))])</span></div>


<span class="k">def</span> <span class="nf">period_hhmm</span><span class="p">(</span><span class="n">intPeriod</span><span class="p">):</span>
    <span class="n">dateTimeAddition</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="p">(</span><span class="n">intPeriod</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">dateTimeValue</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">dateTimeAddition</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">dateTimeValue</span><span class="o">.</span><span class="n">time</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>


<div class="viewcode-block" id="next_period"><a class="viewcode-back" href="../README.html#interface.next_period">[docs]</a><span class="k">def</span> <span class="nf">next_period</span><span class="p">(</span><span class="n">thisTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; advances datetime object by 10 minutes, e.g. &#39;04:50:00&#39; -&gt; &#39;05:00:00&#39; &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">thisTime</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div>


<div class="viewcode-block" id="time_in_seconds"><a class="viewcode-back" href="../README.html#interface.time_in_seconds">[docs]</a><span class="k">def</span> <span class="nf">time_in_seconds</span><span class="p">(</span><span class="n">timestr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; not used - just kept for reference... &quot;&quot;&quot;</span>
    <span class="c1"># &#39;00:01:01&#39; -&gt; 61</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">timestr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)))])</span></div>


<div class="viewcode-block" id="getReadingPeriods"><a class="viewcode-back" href="../README.html#interface.getReadingPeriods">[docs]</a><span class="k">def</span> <span class="nf">getReadingPeriods</span><span class="p">(</span><span class="n">_householdID</span><span class="p">,</span> <span class="n">_condition</span><span class="p">,</span> <span class="n">_duration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; returns start and end of consequitive records matching the condition &quot;&quot;&quot;</span>
    <span class="c1"># used to identify how long &#39;no readings&#39; were taken, or &#39;high readings&#39;</span>
    <span class="n">metaID</span> <span class="o">=</span> <span class="n">getMetaIDs</span><span class="p">(</span><span class="n">_householdID</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">)</span>        <span class="c1"># only fetches the first</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metaID</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idElectricity FROM Electricity WHERE </span><span class="si">%s</span><span class="se">\</span>
<span class="s2">                AND Meta_idMeta = </span><span class="si">%s</span><span class="s2"> ORDER BY dt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_condition</span><span class="p">,</span> <span class="n">metaID</span><span class="p">)</span>
        <span class="n">eIDs</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eIDs</span><span class="p">:</span>
            <span class="n">prevID</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;idElectricity&#39;</span><span class="p">])</span>
            <span class="n">startIDs</span>  <span class="o">=</span> <span class="p">[</span><span class="n">prevID</span><span class="p">]</span>
            <span class="n">endIDs</span>    <span class="o">=</span> <span class="p">[]</span>
            <span class="n">durations</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">eID</span> <span class="ow">in</span> <span class="n">eIDs</span><span class="p">:</span>
                <span class="n">eID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">eID</span><span class="p">[</span><span class="s1">&#39;idElectricity&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">eID</span> <span class="o">!=</span> <span class="p">(</span><span class="n">prevID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">endIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prevID</span><span class="p">)</span>
                    <span class="n">startIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eID</span><span class="p">)</span>
                <span class="n">prevID</span> <span class="o">=</span> <span class="n">eID</span>
            <span class="n">endIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prevID</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">endIDs</span><span class="p">)):</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">endIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">startIDs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="n">_duration</span><span class="p">):</span>
                    <span class="n">durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">durations</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">durations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;no meta entry&quot;</span></div>


<div class="viewcode-block" id="upload_1min_readings"><a class="viewcode-back" href="../README.html#interface.upload_1min_readings">[docs]</a><span class="k">def</span> <span class="nf">upload_1min_readings</span><span class="p">(</span><span class="n">metaIDe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; use panas to resample readings &quot;&quot;&quot;</span>
    <span class="c1"># sqlq = &quot;SELECT Meta.idMeta \ From Meta \ Join Household \ On Household.idHOusehold = Meta.Household_idHousehold \ where Household.status &gt;5 AND Household.status &lt; 10 \ AND DataType = &#39;E&#39; AND Household.Contact_idContact &lt; 5001;&quot;</span>
    <span class="c1"># sqlq = &quot;SELECT distinct(Meta_idMeta) FROM Electricity;&quot; # used for initial catchup on all that is in Electricity table</span>
    <span class="n">dbConnection</span> <span class="o">=</span> <span class="n">getConnection</span><span class="p">()</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;select * from Meter.Electricity where Meta_idMeta=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metaIDe</span>
    <span class="n">df_elec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sqlq</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">dbConnection</span><span class="p">)</span>
    <span class="n">df_elec</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_elec</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>        <span class="c1"># index by time</span>
    <span class="c1"># downsample, label left such that time refers to the next minute</span>
    <span class="n">df_elec_resampled</span> <span class="o">=</span> <span class="n">df_elec</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1min&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="c1"># remove index, so that a new one is auto-incremented</span>
    <span class="k">del</span> <span class="n">df_elec_resampled</span><span class="p">[</span><span class="s1">&#39;idElectricity&#39;</span><span class="p">]</span>
    <span class="c1"># pandas is brutal, if not append it rewrites the table!!</span>
    <span class="n">df_elec_resampled</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">con</span><span class="o">=</span><span class="n">dbConnection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Electricity_1min&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;mysql&#39;</span><span class="p">)</span></div>
    <span class="c1"># df_elec_resampled.to_csv(&quot;%s/el_%s_%s.csv&quot; % (filePath,idMeta[0])) # create a csv copy</span>


<div class="viewcode-block" id="upload_10min_readings"><a class="viewcode-back" href="../README.html#interface.upload_10min_readings">[docs]</a><span class="k">def</span> <span class="nf">upload_10min_readings</span><span class="p">(</span><span class="n">metaIDe</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; use panas to resample readings &quot;&quot;&quot;</span>
    <span class="n">dbConnection</span> <span class="o">=</span> <span class="n">getConnection</span><span class="p">()</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;select * from Meter.Electricity_1min where Meta_idMeta=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metaIDe</span>
    <span class="n">df_elec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sqlq</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">dbConnection</span><span class="p">)</span>
    <span class="c1"># index by time</span>
    <span class="n">df_elec</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_elec</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
    <span class="c1"># downsample, label left such that time refers to the next minute</span>
    <span class="n">df_elec_resampled</span> <span class="o">=</span> <span class="n">df_elec</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;10min&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="c1"># remove index, so that a new one is auto-incremented</span>
    <span class="k">del</span> <span class="n">df_elec_resampled</span><span class="p">[</span><span class="s1">&#39;idElectricity&#39;</span><span class="p">]</span>
    <span class="c1"># pandas is brutal, if not append it rewrites the table!!</span>
    <span class="n">df_elec_resampled</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">con</span><span class="o">=</span><span class="n">dbConnection</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Electricity_10min&#39;</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;mysql&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">uploadDataFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">dataType</span><span class="p">,</span> <span class="n">_metaID</span><span class="p">,</span> <span class="n">collectionDate</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">metaID</span>
    <span class="k">global</span> <span class="n">householdID</span>
    <span class="n">metaID</span> <span class="o">=</span> <span class="n">_metaID</span>

    <span class="n">householdID</span> <span class="o">=</span> <span class="n">getHouseholdForMeta</span><span class="p">(</span><span class="n">metaID</span><span class="p">)</span>
    <span class="c1"># this household gets shown on the &#39;processed&#39; screen</span>
    <span class="n">Screen</span><span class="p">[</span><span class="s1">&#39;7&#39;</span><span class="p">][</span><span class="s1">&#39;Household&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">householdID</span>

    <span class="c1"># put file content into database</span>
    <span class="n">dataFile</span> <span class="o">=</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
    <span class="n">dataFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dataFile</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">):</span>
        <span class="c1"># os.system(&quot;scp &quot; + dataFile + &quot; phil@109.74.196.205:/var/lib/mysql-files&quot;)</span>

        <span class="c1"># XXX makes this the option IF dbHost is localhost</span>
        <span class="c1"># sqlq = &quot;LOAD DATA INFILE &#39;&quot; + dataFile + &quot;&#39; INTO TABLE Electricity FIELDS TERMINATED BY &#39;,&#39; (dt,Watt) SET Meta_idMeta = &quot; + str(metaID) + &quot;;&quot;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;scp &quot;</span> <span class="o">+</span> <span class="n">dataFile</span> <span class="o">+</span> <span class="s2">&quot; phil@109.74.196.205:/home/phil/meter&quot;</span><span class="p">)</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;LOAD DATA INFILE &#39;/home/phil/meter/&quot;</span> <span class="o">+</span> <span class="n">dataFileName</span> <span class="o">+</span> <span class="s2">&quot;&#39; INTO TABLE Electricity FIELDS TERMINATED BY &#39;,&#39; (dt,Watt) SET Meta_idMeta = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">metaID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
        <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">updateHouseholdStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">upload_1min_readings</span><span class="p">(</span><span class="n">metaID</span><span class="p">)</span>
        <span class="n">upload_10min_readings</span><span class="p">(</span><span class="n">metaID</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="c1"># handle the xxxx_act.json file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.json&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_data</span><span class="p">:</span>
            <span class="n">activities</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">activity</span> <span class="ow">in</span> <span class="n">activities</span><span class="p">:</span>
            <span class="n">keyStr</span> <span class="o">=</span> <span class="s2">&quot;`, `&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">activities</span><span class="p">[</span><span class="n">activity</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c1"># escape single quotes from entries - they mess up SQL</span>
            <span class="n">actList</span> <span class="o">=</span> <span class="n">activities</span><span class="p">[</span><span class="n">activity</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">actList</span> <span class="o">=</span> <span class="p">[</span><span class="n">act</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">act</span> <span class="ow">in</span> <span class="n">actList</span><span class="p">]</span>
            <span class="n">valStr</span> <span class="o">=</span> <span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actList</span><span class="p">)</span>
            <span class="n">sqlq</span>   <span class="o">=</span> <span class="s2">&quot;INSERT INTO Activities(`</span><span class="si">%s</span><span class="s2">`) VALUES(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">keyStr</span><span class="p">,</span> <span class="n">valStr</span><span class="p">)</span>
            <span class="n">idAct</span>  <span class="o">=</span> <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
            <span class="c1"># Add path in it&#39;s own table</span>
            <span class="n">path</span>   <span class="o">=</span> <span class="n">activities</span><span class="p">[</span><span class="n">activity</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">idButton</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Path </span><span class="se">\</span>
<span class="s2">                    (`Activities_idActivities`, `idButton`) </span><span class="se">\</span>
<span class="s2">                    VALUES (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idAct</span><span class="p">,</span><span class="n">idButton</span><span class="p">)</span>
                    <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">message</span><span class="p">(</span><span class="s2">&quot;Funny entry </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idButton</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">activities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">):</span>
           <span class="n">quality</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Meta SET </span><span class="se">\</span>
<span class="s2">                `Quality` = &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="se">\</span>
<span class="s2">                WHERE `idMeta` = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quality</span><span class="p">,</span> <span class="n">metaID</span><span class="p">)</span>
        <span class="n">commit</span><span class="p">()</span>
        <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>



    <span class="k">else</span><span class="p">:</span>
        <span class="n">csv_data</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="n">dataFile</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Individual(Meta_idMeta) VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">metaID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span>
            <span class="n">individualID</span> <span class="o">=</span> <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>                             <span class="c1"># create an entry</span>
            <span class="n">commit</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_data</span><span class="p">:</span>                             <span class="c1"># populate columns</span>
                <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Individual SET &quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; = &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;</span><span class="se">\</span>
<span class="s2">                        WHERE idIndividual = &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">individualID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;;&quot;</span>
                <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span>
            <span class="c1"># XXX ??? WILL THIS EVER EXECUTE ??? XXX</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_data</span><span class="p">:</span>                                                       <span class="c1"># insert each line into Activities</span>
                <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Activities(Meta_idMeta,dt_activity,dt_recorded,tuc,category,activity,location,people,enjoyment,path) </span><span class="se">\</span>
<span class="s2">                        VALUES(&#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;)&quot;</span>
                <span class="n">idAct</span> <span class="o">=</span> <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>



    <span class="c1"># update meta entry - this MUST already exist!</span>
    <span class="c1"># we don&#39;t want &#39;I&#39; in the Meta table - only E or A</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">):</span>
        <span class="n">dataType</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
    <span class="n">sn</span> <span class="o">=</span> <span class="n">getDeviceSerialNumber</span><span class="p">(</span><span class="n">dataType</span><span class="p">)</span>
    <span class="n">dtNow</span> <span class="o">=</span> <span class="n">getDateTimeNow</span><span class="p">()</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Meta SET </span><span class="se">\</span>
<span class="s2">            `SerialNumber` = &#39;</span><span class="si">%s</span><span class="s2">&#39;,</span><span class="se">\</span>
<span class="s2">            `DataType`     = &#39;</span><span class="si">%s</span><span class="s2">&#39;,</span><span class="se">\</span>
<span class="s2">            `uploaded`     = &#39;</span><span class="si">%s</span><span class="s2">&#39; </span><span class="se">\</span>
<span class="s2">            WHERE `idMeta` = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">dataType</span><span class="p">,</span> <span class="n">dtNow</span><span class="p">,</span> <span class="n">metaID</span><span class="p">)</span>
    <span class="n">commit</span><span class="p">()</span>
    <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">commit</span><span class="p">()</span>


<div class="viewcode-block" id="getDeviceCount"><a class="viewcode-back" href="../README.html#interface.getDeviceCount">[docs]</a><span class="k">def</span> <span class="nf">getDeviceCount</span><span class="p">(</span><span class="n">householdID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return count of devices configured for this date &quot;&quot;&quot;</span>
    <span class="n">dateChoice</span> <span class="o">=</span> <span class="n">getHHdateChoice</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) FROM Meta WHERE Household_idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39; AND CollectionDate = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">dateChoice</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;COUNT(*)&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="getDeviceMetaIDs"><a class="viewcode-back" href="../README.html#interface.getDeviceMetaIDs">[docs]</a><span class="k">def</span> <span class="nf">getDeviceMetaIDs</span><span class="p">(</span><span class="n">householdID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check if eMeter has been configured &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idMeta, DataType FROM Meta WHERE Household_idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39; ORDER BY Household_idHousehold,DataType;&quot;</span> <span class="o">%</span> <span class="n">householdID</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">metaIDs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">metaIDs</span> <span class="o">=</span> <span class="n">metaIDs</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;6}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;idMeta&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">metaIDs</span></div>


<div class="viewcode-block" id="getDevicesReadings"><a class="viewcode-back" href="../README.html#interface.getDevicesReadings">[docs]</a><span class="k">def</span> <span class="nf">getDevicesReadings</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">dateChoice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check if eMeter has been configured &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idMeta, DataType FROM Meta WHERE Household_idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39; ORDER BY Household_idHousehold,DataType;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="c1"># sqlq = &quot;SELECT idMeta, DataType FROM Meta WHERE Household_idHousehold = &#39;%s&#39; AND CollectionDate = &#39;%s&#39; ORDER BY Household_idHousehold,DataType;&quot; % (householdID,dateChoice)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">Counts</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;DataType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">):</span>
                <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) From Electricity_10min WHERE Meta_idMeta = &#39;</span><span class="si">%s</span><span class="s2">&#39; AND Watt &gt; 20&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;idMeta&#39;</span><span class="p">]</span>
                <span class="n">c_result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">countInt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c_result</span><span class="p">[</span><span class="s1">&#39;COUNT(*)&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT COUNT(*) From Activities WHERE Meta_idMeta = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;idMeta&#39;</span><span class="p">]</span>
                <span class="n">c_result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">countInt</span> <span class="o">=</span> <span class="n">c_result</span><span class="p">[</span><span class="s1">&#39;COUNT(*)&#39;</span><span class="p">]</span>
            <span class="n">countStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:&lt;6}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">countInt</span><span class="p">)</span>
            <span class="n">Counts</span> <span class="o">=</span> <span class="n">Counts</span> <span class="o">+</span> <span class="n">countStr</span>
    <span class="k">return</span> <span class="n">Counts</span></div>


<div class="viewcode-block" id="getDevicesForDate"><a class="viewcode-back" href="../README.html#interface.getDevicesForDate">[docs]</a><span class="k">def</span> <span class="nf">getDevicesForDate</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">dateChoice</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check if eMeter has been configured &quot;&quot;&quot;</span>
    <span class="c1"># sqlq = &quot;SELECT idMeta, DataType FROM Meta WHERE Household_idHousehold = &#39;%s&#39; AND CollectionDate = &#39;%s&#39; ORDER BY Household_idHousehold,DataType;&quot; % (householdID,dateChoice)</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idMeta, DataType FROM Meta WHERE Household_idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39; ORDER BY Household_idHousehold,DataType;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">metaIDs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">metaIDs</span> <span class="o">=</span> <span class="n">metaIDs</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;6}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;idMeta&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">metaIDs</span></div>


<div class="viewcode-block" id="getDeviceRequirements"><a class="viewcode-back" href="../README.html#interface.getDeviceRequirements">[docs]</a><span class="k">def</span> <span class="nf">getDeviceRequirements</span><span class="p">(</span><span class="n">householdID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; formated list of counters and &#39;E&#39; for people/eMeter &quot;&quot;&quot;</span>
    <span class="n">counters</span> <span class="o">=</span> <span class="n">getParticipantCount</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">clist</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counters</span><span class="p">):</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="n">clist</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;6}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;A</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clist</span> <span class="o">=</span> <span class="n">clist</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;6}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">clist</span></div>


<div class="viewcode-block" id="xgetDeviceMetaIDs"><a class="viewcode-back" href="../README.html#interface.xgetDeviceMetaIDs">[docs]</a><span class="k">def</span> <span class="nf">xgetDeviceMetaIDs</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">deviceType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check if eMeter has been configured &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idMeta FROM Meta WHERE DataType = &#39;</span><span class="si">%s</span><span class="s2">&#39; AND Household_idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">deviceType</span><span class="p">,</span> <span class="n">householdID</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">metaIDs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">metaIDs</span> <span class="o">=</span> <span class="n">metaIDs</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;6}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;idMeta&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">metaIDs</span></div>


<span class="k">def</span> <span class="nf">xgetParticipantCounters</span><span class="p">(</span><span class="n">householdID</span><span class="p">):</span>
    <span class="n">counters</span> <span class="o">=</span> <span class="n">getParticipantCount</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">clist</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counters</span><span class="p">):</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="n">clist</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;6}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">clist</span>


<div class="viewcode-block" id="getComment"><a class="viewcode-back" href="../README.html#interface.getComment">[docs]</a><span class="k">def</span> <span class="nf">getComment</span><span class="p">(</span><span class="n">householdID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; get the status for this household &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT CONVERT(comment USING utf8) FROM Household WHERE idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">householdID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">CommentStr</span> <span class="o">=</span> <span class="s2">&quot;Comment: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;CONVERT(comment USING utf8)&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">CommentStr</span><span class="p">,</span> <span class="mi">63</span><span class="p">)</span></div>


<div class="viewcode-block" id="getParticipantCount"><a class="viewcode-back" href="../README.html#interface.getParticipantCount">[docs]</a><span class="k">def</span> <span class="nf">getParticipantCount</span><span class="p">(</span><span class="n">householdID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; get number of diaries required &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT age_group2, age_group3, age_group4, age_group5, age_group6</span><span class="se">\</span>
<span class="s2">            FROM Household </span><span class="se">\</span>
<span class="s2">            WHERE idHousehold = &#39;&quot;</span> <span class="o">+</span> <span class="n">householdID</span> <span class="o">+</span> <span class="s2">&quot;&#39;;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;age_group2&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;age_group3&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;age_group4&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;age_group5&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;age_group6&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="updateDataQuality"><a class="viewcode-back" href="../README.html#interface.updateDataQuality">[docs]</a><span class="k">def</span> <span class="nf">updateDataQuality</span><span class="p">(</span><span class="n">idMeta</span><span class="p">,</span> <span class="n">Quality</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; set Quality in Meta table &quot;&quot;&quot;</span>
    <span class="c1"># called when compose_email(&#39;graph&#39;)</span>
    <span class="c1"># XXX add for diaries</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Meta </span><span class="se">\</span>
<span class="s2">            SET `Quality`= </span><span class="si">%s</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">            WHERE `idMeta` = </span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Quality</span><span class="p">,</span> <span class="n">idMeta</span><span class="p">)</span>
    <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="updateHouseholdStatus"><a class="viewcode-back" href="../README.html#interface.updateHouseholdStatus">[docs]</a><span class="k">def</span> <span class="nf">updateHouseholdStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; update status of household &quot;&quot;&quot;</span>
    <span class="c1"># #statusUpdate</span>
    <span class="n">status</span>
    <span class="c1"># only case 3,5,6 and 7 dealt with here. others from php forms.</span>
    <span class="c1"># 0 : hhq incomplete                hhq.php</span>
    <span class="c1"># 1 : hhq complete but no date      hhq.php</span>
    <span class="c1"># 2 : date selected                 hhq.php</span>
    <span class="c1"># 3 : 2 week warning sent           compose_email(&#39;confirm&#39;)</span>
    <span class="c1"># 31: delay requested</span>
    <span class="c1"># 4 : date confirmed                confirm.php</span>
    <span class="c1"># 5 : kit sent                      device_config()</span>
    <span class="c1"># 6 : data uploaded                 uploadDataFile()</span>
    <span class="c1"># 7 : data emailed to participant   compose_email(&#39;graph&#39;)</span>
    <span class="c1"># 8 : participant made annotations</span>
    <span class="c1"># 10: no el data recorder</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Household </span><span class="se">\</span>
<span class="s2">            SET `status`=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\</span>
<span class="s2">            WHERE `idHousehold` =&#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;;&quot;</span>
    <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="getDeviceSerialNumber"><a class="viewcode-back" href="../README.html#interface.getDeviceSerialNumber">[docs]</a><span class="k">def</span> <span class="nf">getDeviceSerialNumber</span><span class="p">(</span><span class="n">meterType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; download the sn from device - if none present, set one up &quot;&quot;&quot;</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;rm </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">snFilePath</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;adb pull /sdcard/METER/sn.txt </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">snFilePath</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">snFilePath</span><span class="p">)):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">snFilePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sn</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">meterType</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">):</span>
            <span class="c1"># enter sn in window - must be &gt;1000 to not mix up with aMeter</span>
            <span class="n">sn</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># aMeters get auto increment numbers from 1..1000 (?)</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT MAX(SerialNumber)+1 AS sn FROM Meta WHERE SerialNumber &lt;1000&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sn</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sn&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">snFilePath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
            <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;adb push </span><span class="si">%s</span><span class="s2"> /sdcard/METER/&quot;</span> <span class="o">%</span> <span class="n">snFilePath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sn</span></div>


<div class="viewcode-block" id="device_config"><a class="viewcode-back" href="../README.html#interface.device_config">[docs]</a><span class="k">def</span> <span class="nf">device_config</span><span class="p">(</span><span class="n">meterType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; assign meta id and copy config / id files to device &quot;&quot;&quot;</span> 
    <span class="c1"># 2 Nov 15 - assumes that the apps are already installed</span>
    <span class="c1"># global metaID</span>
    <span class="k">global</span> <span class="n">householdID</span>
    <span class="c1"># 1) get the serial number from this device (if given - else &#39;-1&#39; until form completed)</span>
    <span class="n">sn</span> <span class="o">=</span> <span class="n">getDeviceSerialNumber</span><span class="p">(</span><span class="n">meterType</span><span class="p">)</span>

    <span class="c1"># 2) create a meta id entry for an &#39;eMeter&#39;</span>

    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT date_choice FROM Household WHERE idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">householdID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dateChoice</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;date_choice&#39;</span><span class="p">])</span>

    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO Meta(DataType, SerialNumber, Household_idHousehold, CollectionDate) </span><span class="se">\</span>
<span class="s2">               VALUES (&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meterType</span><span class="p">,</span> <span class="n">sn</span><span class="p">,</span> <span class="n">householdID</span><span class="p">,</span> <span class="n">dateChoice</span><span class="p">)</span>
    <span class="n">metaID</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">))</span>
    <span class="n">commit</span><span class="p">()</span>
    <span class="n">updateConfigFile</span><span class="p">(</span><span class="n">metaID</span><span class="p">,</span> <span class="n">dateChoice</span><span class="p">,</span> <span class="n">meterType</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sn</span> <span class="o">==</span> <span class="s1">&#39;-1&#39;</span><span class="p">):</span>
        <span class="c1"># pass current metaID to for to make the update</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;snEntry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">metaID</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;snEntry&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">meterType</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">):</span>
        <span class="n">updateIDfile</span><span class="p">(</span><span class="n">metaID</span><span class="p">)</span>  <span class="c1"># XXX currently douplicated with config file - eMeter could use json file, too...</span>
        <span class="c1"># only need this once per household</span>
        <span class="c1"># print_letter(&#39;parcel&#39;)</span>
        <span class="n">print_address</span><span class="p">()</span>
        <span class="n">updateHouseholdStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">metaID</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sn</span> <span class="o">!=</span> <span class="s1">&#39;-1&#39;</span><span class="p">)):</span>
            <span class="c1"># XXX EXPERIMENTAL - could it have been this change that makes phones not wake up after 7 days?</span>
            <span class="c1"># callShell(&#39;adb shell reboot -p&#39;)</span>
            <span class="c1"># call(&#39;adb shell reboot -p&#39;, shell=True)</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Booklet sticker</span>
        <span class="n">dt</span>   <span class="o">=</span> <span class="n">getHHdtChoice</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
        <span class="n">dt2</span>  <span class="o">=</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-d</span><span class="s2"> %b&quot;</span><span class="p">)</span>
        <span class="n">day1</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a&quot;</span><span class="p">)</span>
        <span class="n">day2</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a&quot;</span><span class="p">)</span>

        <span class="n">templateText</span> <span class="o">=</span> <span class="n">getTemplate</span><span class="p">(</span><span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;from_to.md&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[day1]&quot;</span><span class="p">,</span> <span class="n">day1</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[day2]&quot;</span><span class="p">,</span> <span class="n">day2</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[date]&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[id]&quot;</span><span class="p">,</span> <span class="n">metaID</span><span class="p">)</span>

        <span class="n">printSticker</span><span class="p">(</span><span class="n">templateText</span><span class="p">,</span> <span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;aMeter&quot;</span><span class="p">)</span>

    <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>\
        <span class="s2">&quot;Phone was assigned ID &quot;</span> <span class="o">+</span> <span class="n">metaID</span>
    <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
    <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span></div>


<div class="viewcode-block" id="printSticker"><a class="viewcode-back" href="../README.html#interface.printSticker">[docs]</a><span class="k">def</span> <span class="nf">printSticker</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; pandoc file into printabe format and send to printer &quot;&quot;&quot;</span>
    <span class="n">myFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.md&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">myFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;pandoc -V geometry:paperwidth=8.8cm -V geometry:paperheight=5cm -s </span><span class="si">%s</span><span class="s2">.md -o </span><span class="si">%s</span><span class="s2">.pdf&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">))</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;lp -d MeterLabel -o landscape &#39;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="getDiaryByNumber"><a class="viewcode-back" href="../README.html#interface.getDiaryByNumber">[docs]</a><span class="k">def</span> <span class="nf">getDiaryByNumber</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; pick from the list of &quot;A&quot;-type Meta entries for this HH &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idMeta FROM Meta WHERE DataType = &#39;A&#39; AND Household_idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">householdID</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>

    <span class="n">metaID</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">results</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;idMeta&#39;</span><span class="p">]</span>
    <span class="n">phone_for_paper_diary</span><span class="p">(</span><span class="n">metaID</span><span class="p">)</span></div>


<div class="viewcode-block" id="phone_for_paper_diary"><a class="viewcode-back" href="../README.html#interface.phone_for_paper_diary">[docs]</a><span class="k">def</span> <span class="nf">phone_for_paper_diary</span><span class="p">(</span><span class="n">metaID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; the id is typed on command line &quot;&quot;&quot;</span>

    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT Household_idHousehold FROM Meta WHERE idMeta = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">metaID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">householdID</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Household_idHousehold&#39;</span><span class="p">])</span>

    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT date_choice FROM Household WHERE idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">householdID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dateChoice</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;date_choice&#39;</span><span class="p">])</span>
    <span class="n">updateConfigFile</span><span class="p">(</span><span class="n">metaID</span><span class="p">,</span> <span class="n">dateChoice</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;adb shell am force-stop org.energy_use.meter&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="updateConfigFile"><a class="viewcode-back" href="../README.html#interface.updateConfigFile">[docs]</a><span class="k">def</span> <span class="nf">updateConfigFile</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">_dateChoice</span><span class="p">,</span> <span class="n">meterType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; write id information and created dates and times for follow up queries &quot;&quot;&quot;</span>
    <span class="n">dateFormat</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span>
    <span class="n">dateChoice_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">_dateChoice</span><span class="p">,</span> <span class="n">dateFormat</span><span class="p">)</span>
    <span class="n">startDate</span> <span class="o">=</span> <span class="n">dateChoice_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dateChoice_plus</span> <span class="o">=</span> <span class="n">dateChoice_dt</span>
    <span class="n">dateChoice_plus</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">endDate</span> <span class="o">=</span> <span class="n">dateChoice_plus</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">jstring</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">_id</span><span class="p">}</span>
    <span class="n">jstring</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">startDate</span><span class="p">})</span>
    <span class="n">jstring</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">endDate</span><span class="p">})</span>  <span class="c1"># XXX needs date + 1 Day</span>
    <span class="n">times1</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;17:30:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;18:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;18:30:00&quot;</span><span class="p">]</span>
    <span class="n">times2</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;08:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;08:30:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;17:30:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;18:00:00&quot;</span><span class="p">,</span>
        <span class="s2">&quot;18:30:00&quot;</span><span class="p">]</span>
    <span class="n">dts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">times1</span><span class="p">:</span>
        <span class="n">dts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jstring</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">time</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">times2</span><span class="p">:</span>
        <span class="n">dts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jstring</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">],</span> <span class="n">time</span><span class="p">))</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">meterType</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">):</span>
        <span class="c1"># device for manual entry of paper diary</span>
        <span class="c1"># needs no reminders</span>
        <span class="n">jstring</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;times&quot;</span><span class="p">:</span> <span class="p">[]})</span>
        <span class="c1"># set device time to the day of recording</span>
        <span class="n">dateChoice_dt</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">17</span><span class="p">)</span>
        <span class="n">startDateAdb</span> <span class="o">=</span> <span class="n">dateChoice_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m</span><span class="si">%d</span><span class="s2">%H%M%Y.%S&quot;</span><span class="p">)</span>
        <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;adb root&quot;</span><span class="p">)</span>
        <span class="n">bob</span> <span class="o">=</span> <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;adb shell </span><span class="se">\&quot;</span><span class="s2">date </span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">startDateAdb</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="s2">&quot;adb shell </span><span class="se">\&quot;</span><span class="s2">date </span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">startDateAdb</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="n">bob</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jstring</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;times&quot;</span><span class="p">:</span> <span class="n">dts</span><span class="p">})</span>
        <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;adb root&quot;</span><span class="p">)</span>
        <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb shell &quot;date `date +%m</span><span class="si">%d</span><span class="s1">%H%M%Y.%S`&quot;&#39;</span><span class="p">)</span>
    <span class="n">config_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">configFilePath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">config_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jstring</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">)))</span>
    <span class="n">config_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb shell &quot;mkdir /sdcard/METER/&quot;&#39;</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb push &#39;</span> <span class="o">+</span> <span class="n">configFilePath</span> <span class="o">+</span> <span class="s1">&#39; /sdcard/METER/&#39;</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb shell am force-stop org.energy_use.meter&#39;</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb install -r ./apk/aMeter.apk&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="updateIDfile"><a class="viewcode-back" href="../README.html#interface.updateIDfile">[docs]</a><span class="k">def</span> <span class="nf">updateIDfile</span><span class="p">(</span><span class="n">_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; update device date and id information &quot;&quot;&quot;</span>
    <span class="n">idFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">idFilePath</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
    <span class="n">idFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span>
    <span class="n">idFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># XXX only needs doing once, but flashing doesn&#39;t seem to create this folder</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb shell mkdir /sdcard/METER&#39;</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb push &#39;</span> <span class="o">+</span> <span class="n">idFilePath</span> <span class="o">+</span> <span class="s1">&#39; /sdcard/METER/&#39;</span><span class="p">)</span>
    <span class="c1"># Android 6 (Pixi4) requires:</span>
    <span class="c1"># adb shell &quot;date `date +%m%d%H%M%Y.%S`&quot;</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb shell date -s `date &quot;+%Y%m</span><span class="si">%d</span><span class="s1">.%H%M%S&quot;`&#39;</span><span class="p">)</span></div>
    <span class="c1"># shut down phone (unless id is 0)</span>


<div class="viewcode-block" id="setSerialNumber"><a class="viewcode-back" href="../README.html#interface.setSerialNumber">[docs]</a><span class="k">def</span> <span class="nf">setSerialNumber</span><span class="p">(</span><span class="n">SerialNumber</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; command typed number is set as serial number for current metaID &quot;&quot;&quot;</span>
    <span class="n">metaID</span> <span class="o">=</span> <span class="n">getMetaIDs</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">)</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Meta </span><span class="se">\</span>
<span class="s2">            SET SerialNumber = &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\</span>
<span class="s2">            WHERE idMeta = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SerialNumber</span><span class="p">,</span> <span class="n">metaID</span><span class="p">)</span>
    <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="n">commit</span><span class="p">()</span></div>


<div class="viewcode-block" id="aMeter_setup"><a class="viewcode-back" href="../README.html#interface.aMeter_setup">[docs]</a><span class="k">def</span> <span class="nf">aMeter_setup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; compile and upload the cordova activity app &quot;&quot;&quot;</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;/Users/phil/Sites/MeterApp/platforms/android/cordova/run&#39;</span><span class="p">)</span>
    <span class="c1"># install AutoStart app</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb install ~/Software/Android/AutoStart_2.1.apk&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="root_phone"><a class="viewcode-back" href="../README.html#interface.root_phone">[docs]</a><span class="k">def</span> <span class="nf">root_phone</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; push root and flash packages &quot;&quot;&quot;</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb install -r ./apk/root.apk&#39;</span><span class="p">)</span>
    <span class="c1"># callShell(&#39;adb install -r ./apk/Insecure.apk&#39;)</span>
    <span class="c1"># to configure a phone, install insecure and tick the two boxes to root at start</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb install -r ./apk/Flashify.apk&#39;</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb push ./apk/recovery.img /sdcard/&#39;</span><span class="p">)</span>
    <span class="n">message</span><span class="p">(</span><span class="s2">&quot;Complete process</span><span class="se">\n\</span>
<span class="s2">            1) connect to WiFi</span><span class="se">\n\</span>
<span class="s2">            2) run KingoRoot</span><span class="se">\n\</span>
<span class="s2">            3) Flashify &gt; Recovery image &gt; choose a file </span><span class="se">\&quot;</span><span class="s2">/sdcard/recovery.img</span><span class="se">\&quot;</span><span class="s2"> &gt;yup (2min)</span><span class="se">\n\</span>
<span class="s2">            4) &lt;OK&gt; this message to flash</span><span class="se">\n</span><span class="s2">\)&quot;</span><span class="p">)</span>
    <span class="n">flash_phone</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="flash_phone"><a class="viewcode-back" href="../README.html#interface.flash_phone">[docs]</a><span class="k">def</span> <span class="nf">flash_phone</span><span class="p">(</span><span class="n">meterType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; restore phone from Master copy &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meterType</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">):</span>
        <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb push ./flash_eMeter/TWRP/ /sdcard/&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meterType</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span>
        <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb push ./flash_aMeter/TWRP/ /sdcard/&#39;</span><span class="p">)</span>
    <span class="n">callShell</span><span class="p">(</span><span class="s1">&#39;adb reboot recovery&#39;</span><span class="p">)</span>
    <span class="n">message</span><span class="p">(</span><span class="s2">&quot;Phone restarting</span><span class="se">\n\</span>
<span class="s2">            1) Restore </span><span class="se">\n\</span>
<span class="s2">            2) Select </span><span class="se">\&quot;</span><span class="s2">... KitKat</span><span class="se">\&quot;</span><span class="s2"> swipe (2min) </span><span class="se">\n\</span>
<span class="s2">            3) Reboot System</span><span class="se">\n\</span>
<span class="s2">            4) Reconnect USB (!)</span><span class="se">\n\</span>
<span class="s2">            5) &lt;OK&gt; this message to configure ID&quot;</span><span class="p">)</span>
    <span class="n">updateIDfile</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="eMeter_setup"><a class="viewcode-back" href="../README.html#interface.eMeter_setup">[docs]</a><span class="k">def</span> <span class="nf">eMeter_setup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; superseeded by flash_phone() &quot;&quot;&quot;</span>
    <span class="c1"># Compile and run device_config(E)</span>
    <span class="c1"># XXX call(&#39;ant debug -f ~/Software/Android/DMon/build.xml&#39;, shell=True)</span>
    <span class="c1"># remove old copy</span>
    <span class="c1"># XXX call(&#39;adb uninstall com.Phil.DEMon&#39;, shell=True)</span>
    <span class="c1"># install new</span>
    <span class="c1"># call(&#39;adb install -r \</span>
    <span class="c1">#     ~/Software/Android/DMon/bin/MainActivity-debug.apk&#39;,</span>
    <span class="c1">#      shell=True)</span>
    <span class="c1"># install AutoStart app</span>
    <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb install -r ./apk/AppHider.apk&#39;</span><span class="p">,</span>  <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb install -r ./apk/AutoStart.apk&#39;</span><span class="p">,</span>  <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb install -r ./apk/eMeter.apk&#39;</span><span class="p">,</span>  <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># create the METER folder</span>
    <span class="n">call</span><span class="p">(</span><span class="s1">&#39;adb shell mkdir /sdcard/METER&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># configure phone for recording</span>
    <span class="n">device_config</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="getMetaIDs"><a class="viewcode-back" href="../README.html#interface.getMetaIDs">[docs]</a><span class="k">def</span> <span class="nf">getMetaIDs</span><span class="p">(</span><span class="n">hhID</span><span class="p">,</span> <span class="n">deviceType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; check if eMeter has been configured &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idMeta FROM Meta WHERE DataType = &#39;</span><span class="si">%s</span><span class="s2">&#39; AND Household_idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">deviceType</span><span class="p">,</span> <span class="n">hhID</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;idMeta&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="getHHdateChoice"><a class="viewcode-back" href="../README.html#interface.getHHdateChoice">[docs]</a><span class="k">def</span> <span class="nf">getHHdateChoice</span><span class="p">(</span><span class="n">hhID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; reads a sql date in format &quot;2016-12-31&quot; &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT date_choice FROM Household WHERE idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">hhID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dateStr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;date_choice&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dateStr</span></div>


<div class="viewcode-block" id="getHHdtChoice"><a class="viewcode-back" href="../README.html#interface.getHHdtChoice">[docs]</a><span class="k">def</span> <span class="nf">getHHdtChoice</span><span class="p">(</span><span class="n">hhID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; reads a sql date in format &quot;2016-12-31&quot; and returns datetime object &quot;&quot;&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT date_choice FROM Household WHERE idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">hhID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dateStr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;date_choice&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dateStr</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dateStr</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;None&quot;</span></div>


<div class="viewcode-block" id="getDateChoice"><a class="viewcode-back" href="../README.html#interface.getDateChoice">[docs]</a><span class="k">def</span> <span class="nf">getDateChoice</span><span class="p">(</span><span class="n">hhID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; return collection date as a string: &quot;Sun, 31 Dec&quot; &quot;&quot;&quot;</span>
    <span class="n">this_dt</span> <span class="o">=</span> <span class="n">getHHdtChoice</span><span class="p">(</span><span class="n">hhID</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">this_dt</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">this_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%-d</span><span class="s2"> %b&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;None&quot;</span></div>


<div class="viewcode-block" id="getDateTimeFormated"><a class="viewcode-back" href="../README.html#interface.getDateTimeFormated">[docs]</a><span class="k">def</span> <span class="nf">getDateTimeFormated</span><span class="p">(</span><span class="n">dts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; DateTimeString as received from database: return 31 Jan 16 &quot;&quot;&quot;</span>
    <span class="c1"># http://strftime.org/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dts</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>
        <span class="n">this_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dts</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">this_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-d</span><span class="s2"> %b %y&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;None&quot;</span></div>


<div class="viewcode-block" id="compose_email"><a class="viewcode-back" href="../README.html#interface.compose_email">[docs]</a><span class="k">def</span> <span class="nf">compose_email</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">edit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Contact participant with editabel email &quot;&quot;&quot;</span>
    <span class="c1"># edit = False -&gt; send immediately</span>
    <span class="k">global</span> <span class="n">householdID</span>
    <span class="c1"># get contact details</span>
    <span class="n">contactID</span> <span class="o">=</span> <span class="n">getContact</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">metaID</span>    <span class="o">=</span> <span class="n">getMetaIDs</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">)</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT Name, Surname, Address1,Address2,Town,Postcode,email </span><span class="se">\</span>
<span class="s2">            FROM Contact </span><span class="se">\</span>
<span class="s2">            WHERE idContact = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">contactID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">thisName</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Surname&#39;</span><span class="p">]))</span>
    <span class="n">thisAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;/br&gt;</span><span class="si">%s</span><span class="s2">&lt;/br&gt;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address1&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address2&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Town&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Postcode&#39;</span><span class="p">]))</span>
    <span class="n">thisAddress</span> <span class="o">=</span> <span class="n">thisAddress</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;None &lt;/br&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">thisDate</span>    <span class="o">=</span> <span class="n">getDateChoice</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">thisEmail</span>   <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]))</span>
    <span class="n">CcEmail</span>     <span class="o">=</span> <span class="s1">&#39;meter@energy.ox.ac.uk&#39;</span>
    <span class="n">thisAddress</span> <span class="o">=</span> <span class="n">thisAddress</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;None&lt;/br&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">participantCount</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">getParticipantCount</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">householdID</span><span class="p">)))</span>
    <span class="c1"># prepare the custom email</span>
    <span class="c1"># templateFile = open(emailPath + &quot;email_compose_&quot; + type + &quot;.md&quot;, &quot;r&quot;)</span>
    <span class="n">templateFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">emailPath</span> <span class="o">+</span> <span class="s2">&quot;email_&quot;</span> <span class="o">+</span> <span class="nb">type</span> <span class="o">+</span> <span class="s2">&quot;.html&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">templateFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[householdID]&quot;</span><span class="p">,</span> <span class="n">householdID</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[contactID]&quot;</span><span class="p">,</span> <span class="n">contactID</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[name]&quot;</span><span class="p">,</span> <span class="n">thisName</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[address]&quot;</span><span class="p">,</span> <span class="n">thisAddress</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[date]&quot;</span><span class="p">,</span> <span class="n">thisDate</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[metaID]&quot;</span><span class="p">,</span> <span class="n">metaID</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[securityCode]&quot;</span><span class="p">,</span> <span class="n">getSecurityCode</span><span class="p">(</span><span class="n">householdID</span><span class="p">))</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[participantCount]&quot;</span><span class="p">,</span> <span class="n">participantCount</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">participantCount</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[s]&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[ies]&quot;</span><span class="p">,</span> <span class="s2">&quot;ies&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[people]&quot;</span><span class="p">,</span> <span class="s2">&quot;people&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{multiple booklets}&quot;</span><span class="p">,</span> <span class="s2">&quot;. Each of you is encouraged to take part (so long as they are eight or older). I hope you will be able to persuade them to join you&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[ies]&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[people]&quot;</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{multiple booklets}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">edit</span><span class="p">):</span>
        <span class="c1"># needs email in line 1, Cc in line 2 and Subject in line 3</span>
        <span class="c1"># template has subject as line one -&gt; insert emails</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">thisEmail</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">CcEmail</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">templateText</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># only keep the body of the text -&gt; remove line 1 (Subject)</span>
        <span class="n">subjectLine</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="p">[</span><span class="n">templateText</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>     <span class="c1"># find line break and return all from there - i.e. remove first line</span>

    <span class="n">emailFilePath</span> <span class="o">=</span> <span class="n">emailPath</span> <span class="o">+</span> <span class="s2">&quot;tempEmail.htmail&quot;</span>
    <span class="n">emailFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">emailFilePath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
    <span class="n">emailFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">templateText</span><span class="p">)</span>
    <span class="n">emailFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;confirm&#39;</span><span class="p">):</span>
        <span class="n">updateHouseholdStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;reschedule&#39;</span><span class="p">):</span>
        <span class="c1"># I asked for a new date</span>
        <span class="n">updateHouseholdStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;graph&#39;</span><span class="p">):</span>
        <span class="c1"># households that had been &#39;processed&#39; and now &#39;processed and contacted&#39;</span>
        <span class="n">updateHouseholdStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">updateDataQuality</span><span class="p">(</span><span class="n">metaID</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;fail&#39;</span><span class="p">):</span>
        <span class="n">updateHouseholdStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">updateDataQuality</span><span class="p">(</span><span class="n">metaID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">edit</span><span class="p">):</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;vim &#39;</span> <span class="o">+</span> <span class="n">emailFilePath</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>  <span class="c1"># XXX does not have the desired effect of removing the light &#39;vim&#39; background</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mutt -e &quot;set content_type=text/html&quot; -s &quot;&#39;</span> <span class="o">+</span> <span class="n">subjectLine</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span> <span class="o">+</span> <span class="n">thisEmail</span> <span class="o">+</span> <span class="s1">&#39; -b meter@energy.ox.ac.uk &lt; &#39;</span> <span class="o">+</span> <span class="n">emailFilePath</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 29 Jan 2017 added to redraw screen after mailing</span>
    <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span></div>


<div class="viewcode-block" id="email_many"><a class="viewcode-back" href="../README.html#interface.email_many">[docs]</a><span class="k">def</span> <span class="nf">email_many</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; compose message &quot;&quot;&quot;</span>
    <span class="n">emailFilePath</span> <span class="o">=</span> <span class="n">emailPath</span> <span class="o">+</span> <span class="s2">&quot;email_many.html&quot;</span>
    <span class="c1"># give oportunity to edit the template</span>
    <span class="n">call</span><span class="p">(</span><span class="s1">&#39;vim &#39;</span> <span class="o">+</span> <span class="n">emailFilePath</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">templateFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">emailFilePath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">templateFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">subjectLine</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="p">[</span><span class="n">templateText</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>     <span class="c1"># find line break and return all from there - i.e. remove first line</span>

    <span class="c1"># personalise</span>
    <span class="n">emailPathPersonal</span> <span class="o">=</span> <span class="n">emailPath</span> <span class="o">+</span> <span class="s2">&quot;email_personal.html&quot;</span>
    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT Name, email FROM Mailinglist WHERE scope = &#39;test&#39;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">emailText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[name]&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
        <span class="n">emailAddress</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
        <span class="n">emailFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">emailPathPersonal</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
        <span class="n">emailFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">emailText</span><span class="p">)</span>
        <span class="n">emailFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mutt -e &quot;set content_type=text/html&quot; -s &quot;&#39;</span> <span class="o">+</span> <span class="n">subjectLine</span> <span class="o">+</span> <span class="s1">&#39;&quot; &#39;</span> <span class="o">+</span> <span class="n">emailAddress</span> <span class="o">+</span> <span class="s1">&#39; &lt; &#39;</span> <span class="o">+</span> <span class="n">emailPathPersonal</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">getTemplate</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
    <span class="n">templateFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">templateFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">templateText</span>


<div class="viewcode-block" id="print_address"><a class="viewcode-back" href="../README.html#interface.print_address">[docs]</a><span class="k">def</span> <span class="nf">print_address</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; formated address label &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">householdID</span>
    <span class="n">contactID</span> <span class="o">=</span> <span class="n">getContact</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>

    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT Name, Surname, Address1,Address2,Town,Postcode FROM Contact WHERE idContact = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">contactID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">thisName</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Surname&#39;</span><span class="p">]))</span>

    <span class="n">address</span> <span class="o">=</span> <span class="n">getTemplate</span><span class="p">(</span><span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;_address.md&quot;</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Name]&quot;</span><span class="p">,</span>      <span class="n">thisName</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Address1]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address1&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Address2]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address2&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Town]&quot;</span><span class="p">,</span>     <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Town&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Postcode]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Postcode&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">printSticker</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;address&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_letter"><a class="viewcode-back" href="../README.html#interface.print_letter">[docs]</a><span class="k">def</span> <span class="nf">print_letter</span><span class="p">(</span><span class="n">letterType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; personal letter as pdf &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">householdID</span>
    <span class="n">contactID</span> <span class="o">=</span> <span class="n">getContact</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">participantCount</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">getParticipantCount</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">householdID</span><span class="p">)))</span>

    <span class="c1"># The letter</span>
    <span class="n">dateToday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">todayDate</span> <span class="o">=</span> <span class="n">dateToday</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2"> %B %Y&quot;</span><span class="p">)</span>

    <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT Name, Surname, Address1,Address2,Town,Postcode FROM Contact WHERE idContact = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="n">contactID</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">thisName</span>    <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Surname&#39;</span><span class="p">]))</span>
    <span class="n">thisAddress</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address1&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address2&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Town&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Postcode&#39;</span><span class="p">]))</span>
    <span class="n">thisAddress</span> <span class="o">=</span> <span class="n">thisAddress</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;None</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">dt</span>   <span class="o">=</span> <span class="n">getHHdtChoice</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
    <span class="n">dt2</span>  <span class="o">=</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-d</span><span class="s2"> %b&quot;</span><span class="p">)</span>
    <span class="n">weekday</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%A&quot;</span><span class="p">)</span>
    <span class="n">nextday</span> <span class="o">=</span> <span class="n">dt2</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%A&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">letterType</span> <span class="o">==</span> <span class="s2">&quot;chase_eMeter&quot;</span><span class="p">):</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">getTemplate</span><span class="p">(</span><span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;letter_chase_eMeter.md&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">getTemplate</span><span class="p">(</span><span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;letter_narrow.md&quot;</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[address]&quot;</span><span class="p">,</span> <span class="n">thisAddress</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[name]&quot;</span><span class="p">,</span> <span class="n">thisName</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[today]&quot;</span><span class="p">,</span> <span class="n">todayDate</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[date]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">date</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[weekday]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">weekday</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[nextday]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">nextday</span><span class="p">)</span>
    <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[participantCount]&quot;</span><span class="p">,</span> <span class="n">participantCount</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">participantCount</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[s]&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{multiple booklets}&quot;</span><span class="p">,</span> <span class="s2">&quot; -- to help you identify them there are numbers on the back (1 for the oldest, 2 second oldest...). Do encourage the others to join you. The more people contribute, the better our understanding of electricity use becomes&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">templateText</span> <span class="o">=</span> <span class="n">templateText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{multiple booklets}&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">myFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;temp_letter.md&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span>
    <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">templateText</span><span class="p">)</span>
    <span class="n">myFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">letterFile</span> <span class="o">=</span> <span class="n">letterPath</span> <span class="o">+</span> <span class="n">contactID</span> <span class="o">+</span> <span class="s2">&quot;_letter&quot;</span>

    <span class="n">call</span><span class="p">(</span><span class="s1">&#39;pandoc  --variable classoption=twocolumn -V geometry:margin=0.6in -V fontsize=11pt -s &#39;</span> <span class="o">+</span> <span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;temp_letter.md -o&quot;</span> <span class="o">+</span> <span class="n">letterFile</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">call</span><span class="p">(</span><span class="s1">&#39;lp -d Xerox_Phaser_3250 &#39;</span> <span class="o">+</span> <span class="n">letterFile</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># ADDRESS LABEL</span>
    <span class="c1"># produces postage label and personal letter</span>

    <span class="n">address</span> <span class="o">=</span> <span class="n">getTemplate</span><span class="p">(</span><span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;_address.md&quot;</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Name]&quot;</span><span class="p">,</span>      <span class="n">thisName</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Address1]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address1&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Address2]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Address2&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Town]&quot;</span><span class="p">,</span>     <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Town&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[Postcode]&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Postcode&#39;</span><span class="p">])</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">printSticker</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">letterPath</span> <span class="o">+</span> <span class="s2">&quot;address&quot;</span><span class="p">)</span></div>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># --------------------------FORMS-----------------------------------------------</span>
<span class="c1"># ------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="ActionControllerData"><a class="viewcode-back" href="../README.html#interface.ActionControllerData">[docs]</a><span class="k">class</span> <span class="nc">ActionControllerData</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">MultiLineAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; action key shortcuts &quot;&quot;&quot;</span>
    <span class="c1"># #action_keys</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; set keys for all screens &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ActionControllerData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">MasterKeys</span>
        <span class="n">MasterKeys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SwitchScreen</span><span class="p">,</span>
            <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_MainMenu</span><span class="p">,</span>
            <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exit_application</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">data_download</span><span class="p">,</span>
            <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_snEntry</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">global</span> <span class="n">MasterKeysLabels</span>
        <span class="n">MasterKeysLabels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="s1">&#39; Home&#39;</span><span class="p">,</span>
            <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="s1">&#39; Back&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="s1">&#39;uit&#39;</span><span class="p">,</span>
            <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;rocess&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_handlers</span><span class="p">(</span><span class="n">MasterKeys</span><span class="p">)</span>

        <span class="c1"># global MenuActionKeys</span>
        <span class="c1"># MenuActionKeys = {</span>
        <span class="c1">#     # &#39;1&#39;: self.eMeter_setup,</span>
        <span class="c1">#     #   &#39;p&#39;: self.eMeter_setup,</span>
        <span class="c1">#     # &#39;A&#39;: print_letter,</span>
        <span class="c1">#     &#39;A&#39;: self.btnA,</span>
        <span class="c1">#     &#39;B&#39;: self.btnB,</span>
        <span class="c1">#     ## &#39;A&#39;: self_pre_post_email,</span>
        <span class="c1">#     &#39;D&#39;: self.aMeter_id_setup,</span>
        <span class="c1">#     &#39;E&#39;: self.btnE,</span>
        <span class="c1">#     &#39;&gt;&#39;: getNextHousehold,</span>
        <span class="c1">#     &#39;&lt;&#39;: getPreviousHousehold,</span>

        <span class="c1">#     &#39;0&#39;: self.SwitchScreen,</span>
        <span class="c1">#     &#39;1&#39;: self.SwitchScreen,</span>
        <span class="c1">#     &#39;2&#39;: self.SwitchScreen,</span>
        <span class="c1">#     &#39;3&#39;: self.SwitchScreen,</span>
        <span class="c1">#     # &#39;1&#39;: self.Screen1,</span>
        <span class="c1">#     # &#39;2&#39;: self.Screen2,</span>
        <span class="c1">#     # &#39;3&#39;: self.Screen3,</span>
        <span class="c1">#     # &#39;4&#39;: self.Screen4,</span>
        <span class="c1">#     # &#39;5&#39;: self.Screen5,</span>

        <span class="c1">#     &#39;P&#39;: self.btnP,</span>
        <span class="c1">#     # &#39;P&#39;: self.data_download,</span>
        <span class="c1">#     # &#39;S&#39;: self.showHouseholds,</span>
        <span class="c1">#     # &quot;M&quot;: toggleScreenKey,</span>
        <span class="c1">#     &quot;q&quot;: self.show_MainMenu,</span>
        <span class="c1">#     &quot;Q&quot;: self.parent.exit_application,</span>
        <span class="c1">#     # &quot;t&quot;: self.show_DataTypes,</span>
        <span class="c1">#     # &quot;c&quot;: self.show_Contact,</span>
        <span class="c1">#     # &quot;a&quot;: self.show_NewContact,</span>
        <span class="c1">#     # &quot;I&quot;: self.show_Individual,</span>
        <span class="c1">#     # &quot;m&quot;: self.show_MetaForm,</span>
        <span class="c1">#     # &quot;s&quot;: self.show_MainMenu,</span>
        <span class="c1"># }</span>
        <span class="c1"># message(&quot;%s&quot;% self.add_handlers)</span>
        <span class="c1"># self.add_handlers(MenuActionKeys)</span>

<div class="viewcode-block" id="ActionControllerData.actionHighlighted"><a class="viewcode-back" href="../README.html#interface.ActionControllerData.actionHighlighted">[docs]</a>    <span class="k">def</span> <span class="nf">actionHighlighted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectedLine</span><span class="p">,</span> <span class="n">keypress</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; choose action based on the display status and selected line &quot;&quot;&quot;</span>
        <span class="c1"># #action_highlighted</span>
        <span class="k">global</span> <span class="n">householdID</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">==</span> <span class="s1">&#39;Main&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Selection: &#39;</span><span class="p">,</span> <span class="n">selectedLine</span><span class="p">,</span>
                                        <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">M</span><span class="se">\t\t</span><span class="s1"> to return to the main menu&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="k">global</span> <span class="n">ActionKeys</span>
            <span class="n">ActionKeys</span><span class="p">[</span><span class="n">selectedLine</span><span class="p">[</span><span class="mi">1</span><span class="p">]]()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">==</span> <span class="s1">&#39;Contact&#39;</span><span class="p">):</span>
            <span class="n">dataArray</span> <span class="o">=</span> <span class="n">selectedLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">householdID</span> <span class="o">=</span> <span class="n">getHouseholdForContact</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">message</span><span class="p">(</span><span class="s2">&quot;Waring:</span><span class="se">\n</span><span class="s2">There may be other Household entries for this Contact&quot;</span><span class="p">)</span>
            <span class="c1"># contactID = str(dataArray[0])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>\
                <span class="s2">&quot;Contact changed to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">==</span> <span class="s1">&#39;Households&#39;</span><span class="p">):</span>
            <span class="c1"># items are padded out with spaces to produce neat columns. These are removed with .strip()</span>
            <span class="n">dataArray</span>   <span class="o">=</span> <span class="n">selectedLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">householdID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>\
                <span class="s2">&quot;Household changed to &quot;</span> <span class="o">+</span> <span class="n">householdID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">==</span> <span class="s1">&#39;Meta&#39;</span><span class="p">):</span>
            <span class="n">dataArray</span> <span class="o">=</span> <span class="n">selectedLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">global</span> <span class="n">metaID</span>
            <span class="n">metaID</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">dataType</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>\
                <span class="s2">&quot;Meta &quot;</span> <span class="o">+</span> <span class="n">metaID</span> <span class="o">+</span> <span class="s2">&quot;, type &quot;</span> <span class="o">+</span> <span class="n">dataType</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">==</span> <span class="s1">&#39;Household&#39;</span><span class="p">):</span>
            <span class="n">dataArray</span> <span class="o">=</span> <span class="n">selectedLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">householdID</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>\
                <span class="s2">&quot;Household changed to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">==</span> <span class="s1">&#39;Individual&#39;</span><span class="p">):</span>
            <span class="n">dataArray</span> <span class="o">=</span> <span class="n">selectedLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span>\
                <span class="s2">&quot;Individual changed to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; from household &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataArray</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">==</span> <span class="s1">&#39;Tables&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Table &#39;</span><span class="p">,</span> <span class="n">selectedLine</span><span class="p">,</span> <span class="s1">&#39;was selected!&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="n">selectedLine</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check if command key is present in format [x]</span>
            <span class="n">Key</span> <span class="o">=</span> <span class="n">selectedLine</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ActionKeys</span><span class="p">[</span><span class="n">Key</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="nb">ord</span><span class="p">(</span><span class="n">Key</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">message</span><span class="p">(</span><span class="s2">&quot;No action for </span><span class="si">%s</span><span class="s2"> defined&quot;</span> <span class="o">%</span> <span class="n">Key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="ActionControllerData.mute"><a class="viewcode-back" href="../README.html#interface.ActionControllerData.mute">[docs]</a>    <span class="k">def</span> <span class="nf">mute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; does nothing &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ActionControllerData.updateActionKeys"><a class="viewcode-back" href="../README.html#interface.ActionControllerData.updateActionKeys">[docs]</a>    <span class="k">def</span> <span class="nf">updateActionKeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ScreenKey</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; redefine what keys do &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">ActionKeys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ActionKeys</span><span class="p">:</span>
            <span class="c1"># make all &#39;old&#39; Action keys &#39;mute&#39;</span>
            <span class="n">ActionKeys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mute</span>
        <span class="k">for</span> <span class="n">ScreenNumber</span> <span class="ow">in</span> <span class="n">Screen</span><span class="p">:</span>
            <span class="c1"># Screen keys (0-n) always work</span>
            <span class="n">ActionKeys</span><span class="p">[</span><span class="n">ScreenNumber</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SwitchScreen</span>
        <span class="k">for</span> <span class="n">ActionKey</span> <span class="ow">in</span> <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">]:</span>
            <span class="c1"># Actions specific to this screen</span>
            <span class="n">ActionKeys</span><span class="p">[</span><span class="n">ActionKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">][</span><span class="n">ActionKey</span><span class="p">][</span><span class="s1">&#39;Action&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_handlers</span><span class="p">(</span><span class="n">ActionKeys</span><span class="p">)</span></div>

<div class="viewcode-block" id="ActionControllerData.SwitchScreen"><a class="viewcode-back" href="../README.html#interface.ActionControllerData.SwitchScreen">[docs]</a>    <span class="k">def</span> <span class="nf">SwitchScreen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; convert key number to character (48 -&gt; &#39;0&#39;) &quot;&quot;&quot;</span>
        <span class="n">Key</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateActionKeys</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Key</span><span class="p">)</span>
        <span class="n">showScreen</span><span class="p">(</span><span class="n">Key</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">show_MainMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">aMeter_id_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="n">device_config</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">showHouseholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s1">&#39;Households&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">data_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="n">data_download</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_Contact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">=</span> <span class="s1">&#39;Contact&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s2">&quot;Contact&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_Individual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">=</span> <span class="s1">&#39;Individual&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s2">&quot;Individual&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_MetaForm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;MetaForm&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_EditContact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;EditContact&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_EditHousehold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;EditHousehold&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_NewContact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;NewContact&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_snEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="n">device_config</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formated_data_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vl</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">formated_word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vl</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="ActionControllerSearch"><a class="viewcode-back" href="../README.html#interface.ActionControllerSearch">[docs]</a><span class="k">class</span> <span class="nc">ActionControllerSearch</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">ActionControllerSimple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; search and command settings &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s1">&#39;^/.*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_search</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s1">&#39;^:\d.*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_serialNumber</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s1">&#39;^:d\d\d\d\d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paperDiary</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s1">&#39;^:c\d\d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setContact</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s1">&#39;^:h\d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setHousehold</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s1">&#39;^:m\d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">setMetaID</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="s1">&#39;^:d\d$&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paperDiaryNumber</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">set_filter</span><span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setHousehold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>  <span class="c1"># entered as 4 digit</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">householdExists</span><span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])):</span>
            <span class="k">global</span> <span class="n">householdID</span>
            <span class="n">householdID</span> <span class="o">=</span> <span class="n">command_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s2">&quot;No household ID=</span><span class="si">%s</span><span class="s2"> found&quot;</span> <span class="o">%</span> <span class="n">command_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">setContact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>  <span class="c1"># entered as 4 digit</span>
        <span class="k">global</span> <span class="n">householdID</span>
        <span class="n">householdID</span> <span class="o">=</span> <span class="n">getHouseholdForContact</span><span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setMetaID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>  <span class="c1"># entered as 4 digit</span>
        <span class="k">global</span> <span class="n">householdID</span>
        <span class="n">householdID</span> <span class="o">=</span> <span class="n">getHouseholdForMeta</span><span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">paperDiary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>  <span class="c1"># entered as 4 digit</span>
        <span class="n">phone_for_paper_diary</span><span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">paperDiaryNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>  <span class="c1"># entered as single digit (for current HH)</span>
        <span class="n">getDiaryByNumber</span><span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">set_serialNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>  <span class="c1"># just for testing</span>
        <span class="n">setSerialNumber</span><span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># NEEDED???</span>
    <span class="k">def</span> <span class="nf">setMainMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="p">,</span> <span class="n">live</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span></div>


<div class="viewcode-block" id="MeterMain"><a class="viewcode-back" href="../README.html#interface.MeterMain">[docs]</a><span class="k">class</span> <span class="nc">MeterMain</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">FormMuttActiveTraditionalWithMenus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; npyScreen from with mutt style features &quot;&quot;&quot;</span>
    <span class="n">ACTION_CONTROLLER</span> <span class="o">=</span> <span class="n">ActionControllerSearch</span>
    <span class="n">MAIN_WIDGET_CLASS</span> <span class="o">=</span> <span class="n">ActionControllerData</span>
    <span class="c1"># myStatus = Screen[str(ScreenKey)][&#39;Name&#39;]</span>
    <span class="n">myStatus</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Meter Interface&quot;</span>

    <span class="k">global</span> <span class="n">cursor</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">connectDatabaseOLD</span><span class="p">(</span><span class="n">dbHost</span><span class="p">)</span>

<div class="viewcode-block" id="MeterMain.beforeEditing"><a class="viewcode-back" href="../README.html#interface.MeterMain.beforeEditing">[docs]</a>    <span class="k">def</span> <span class="nf">beforeEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; connect/reconnect &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">cursor</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connectDatabase</span><span class="p">(</span><span class="n">dbHost</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">first_time</span>
        <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
            <span class="n">first_time</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>
            <span class="c1"># load Screen</span>
            <span class="k">global</span> <span class="n">Screen</span>
            <span class="n">Screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getScreens</span><span class="p">()</span>
        <span class="n">showScreen</span><span class="p">(</span><span class="n">ScreenKey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;METER &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">display</span><span class="p">()</span></div>

<div class="viewcode-block" id="MeterMain.initialise"><a class="viewcode-back" href="../README.html#interface.MeterMain.initialise">[docs]</a>    <span class="k">def</span> <span class="nf">initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; menu and sub-menues &quot;&quot;&quot;</span>
        <span class="c1"># #menu_bar</span>

        <span class="c1"># global dataType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_menu</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Data handling&quot;</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Download from device&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">data_download</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m1</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Review downloaded data&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">data_review</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># self.m1.addItemsFromList([</span>
        <span class="c1">#     (&quot;Download from phone&quot;, data_download, &quot;d&quot;),</span>
        <span class="c1">#     (&quot;Review Meta Data&quot;, data_review, &quot;r&quot;),</span>
        <span class="c1"># ])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_menu</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Participants&quot;</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Select contact&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_contacts</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Edit   contact&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">show_EditContact</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Select households&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Households&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Edit   household&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">show_EditHousehold</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;New    contact&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">add_contact</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_menu</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Emails&quot;</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;e&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email many&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">email_many</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email blank&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blank&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Date reschedule&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reschedule&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email confirm date&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;confirm&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email pack sent&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parcel&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email graph&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email on failure&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Request return&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;request_return&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;------No editing------&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">IgnoreForNow</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email blank&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blank&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email confirm date&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;confirm&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email pack sent&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parcel&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email graph&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Email on failure&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">compose_email</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_menu</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Database management&quot;</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Show tables&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">show_Tables</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Select meta&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_meta</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Change database&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">toggleDatabase</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Backup database&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">backup_database</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_menu</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Configure devices&quot;</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;eMeter ID&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">device_config</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;aMeter ID&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">device_config</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;aMeter for Paper Diary&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">device_config</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
        <span class="c1"># self.m2.addItem(text=&#39;eMeter apk&#39;, onSelect=eMeter_setup, shortcut=&#39;E&#39;, arguments=None)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Flash eMeter&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">flash_phone</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Flash aMeter&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">flash_phone</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;aMeter app upload&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">aMeter_setup</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Root phone&#39;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">root_phone</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_menu</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Exit&quot;</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m3</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m3</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;Exit&quot;</span><span class="p">,</span> <span class="n">onSelect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_application</span><span class="p">,</span> <span class="n">shortcut</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MeterMain.getMenuText"><a class="viewcode-back" href="../README.html#interface.MeterMain.getMenuText">[docs]</a>    <span class="k">def</span> <span class="nf">getMenuText</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get content based on current ScreenKey &quot;&quot;&quot;</span>
        <span class="c1"># #menu_text</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">householdID</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
            <span class="c1"># a hh is assigned</span>
            <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getHHindex</span><span class="p">(</span><span class="n">householdID</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get the 1st in the list</span>
            <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getHH</span><span class="p">()</span>

        <span class="n">contactID</span>   <span class="o">=</span> <span class="n">getContact</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>

        <span class="n">MenuText</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">|_______________________________________|&quot;</span>
        <span class="n">longline</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">|_________________________________________________________________|&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Home&#39;</span><span class="p">):</span>
            <span class="c1"># HOME Screen</span>
            <span class="c1"># Show METER logo</span>
            <span class="k">for</span> <span class="n">logoLine</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;meterLogo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">):</span>
                <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">logoLine</span><span class="p">)</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Show screen options</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> _Screen options________________________&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Screen</span><span class="p">):</span>
                <span class="c1"># display all screens</span>
                <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBox</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">Screen</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]),</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">getHouseholdCount</span><span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Criterium&#39;</span><span class="p">]))))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">]):</span>
            <span class="c1"># Show keys available</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> _Commands______________________________&quot;</span><span class="p">)</span>
            <span class="c1"># MenuText.append (formatBox(&quot;&quot;,&quot;&quot;))</span>
            <span class="k">for</span> <span class="n">ActionKey</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">]):</span>
                <span class="c1"># show avalable commands</span>
                <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBox</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ActionKey</span><span class="p">,</span> <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">][</span><span class="n">ActionKey</span><span class="p">][</span><span class="s1">&#39;Label&#39;</span><span class="p">]),</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">householdID</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span><span class="p">):</span>
            <span class="c1"># Show Household information</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> _Household information  (</span><span class="si">%3s</span><span class="s2">/</span><span class="si">%3s</span><span class="s2">) _______________________________&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Index&#39;</span><span class="p">],</span> <span class="n">getHouseholdCount</span><span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Criterium&#39;</span><span class="p">])))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;Contact:&quot;</span><span class="p">,</span>  <span class="n">getNameOfContact</span><span class="p">(</span><span class="n">contactID</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">contactID</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">))</span>
            <span class="n">line</span>
            <span class="n">status</span>  <span class="o">=</span> <span class="n">getStatus</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
            <span class="n">date</span>    <span class="o">=</span> <span class="n">getDateChoice</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
            <span class="n">dt_date</span> <span class="o">=</span> <span class="n">getHHdateChoice</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;Date:&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;Household:&quot;</span><span class="p">,</span> <span class="n">householdID</span><span class="p">))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;Status:&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;People:&quot;</span><span class="p">,</span> <span class="n">getDeviceRequirements</span><span class="p">(</span><span class="n">householdID</span><span class="p">)))</span>
            <span class="c1"># MenuText.append(formatBigBox(&quot;Devices:&quot;, getDeviceMetaIDs(householdID)))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;Devices:&quot;</span><span class="p">,</span> <span class="n">getDevicesForDate</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">dt_date</span><span class="p">)))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;Readings:&quot;</span><span class="p">,</span> <span class="n">getDevicesReadings</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">dt_date</span><span class="p">)))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">):</span>
                <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;Low:&quot;</span><span class="p">,</span>  <span class="n">getReadingPeriods</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">Criteria</span><span class="p">[</span><span class="s1">&#39;no reading&#39;</span><span class="p">],</span> <span class="mi">60</span><span class="p">)))</span>  <span class="c1"># last parameter is min duration to report</span>
                <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatBigBox</span><span class="p">(</span><span class="s2">&quot;High:&quot;</span><span class="p">,</span> <span class="n">getReadingPeriods</span><span class="p">(</span><span class="n">householdID</span><span class="p">,</span> <span class="n">Criteria</span><span class="p">[</span><span class="s1">&#39;high reading&#39;</span><span class="p">],</span> <span class="mi">60</span><span class="p">)))</span>  <span class="c1"># last parameter is min duration to report</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">formatBoxList</span><span class="p">(</span><span class="n">getComment</span><span class="p">(</span><span class="n">householdID</span><span class="p">)))</span>
            <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longline</span><span class="p">)</span>
        <span class="n">MenuText</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MenuText</span></div>

<div class="viewcode-block" id="MeterMain.email"><a class="viewcode-back" href="../README.html#interface.MeterMain.email">[docs]</a>    <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; compose_email(Screen[ScreenKey][chr(key)[&#39;EmailType&#39;]) &quot;&quot;&quot;</span>
        <span class="n">compose_email</span><span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">][</span><span class="nb">chr</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="s1">&#39;arguments&#39;</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">showHouseholds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s1">&#39;Households&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deviceConfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">deviceCount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">getDeviceCount</span><span class="p">(</span><span class="n">householdID</span><span class="p">))</span>
        <span class="n">participantCount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">getParticipantCount</span><span class="p">(</span><span class="n">householdID</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">deviceCount</span> <span class="o">&lt;</span> <span class="n">participantCount</span><span class="p">):</span>
            <span class="n">device_config</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">deviceCount</span> <span class="o">==</span> <span class="n">participantCount</span><span class="p">):</span>
            <span class="n">device_config</span><span class="p">(</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s2">&quot;All devices are configured (or should be :-)&quot;</span><span class="p">)</span>
        <span class="c1"># recount after new device configured</span>
        <span class="n">deviceCount</span> <span class="o">=</span> <span class="n">getDeviceCount</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">deviceCount</span> <span class="o">&lt;</span> <span class="n">participantCount</span><span class="p">):</span>
            <span class="n">Screen</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">][</span><span class="s1">&#39;D&#39;</span><span class="p">][</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Configure A</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">deviceCount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Screen</span><span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">][</span><span class="s1">&#39;Actions&#39;</span><span class="p">][</span><span class="s1">&#39;D&#39;</span><span class="p">][</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Configure eMeter&quot;</span>

<div class="viewcode-block" id="MeterMain.getHHindex"><a class="viewcode-back" href="../README.html#interface.MeterMain.getHHindex">[docs]</a>    <span class="k">def</span> <span class="nf">getHHindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">HouseholdID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; find at what position in the list the current hh is &quot;&quot;&quot;</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT rank </span><span class="se">\</span>
<span class="s2">                FROM ( </span><span class="se">\</span>
<span class="s2">                    SELECT idHousehold, date_choice,</span><span class="se">\</span>
<span class="s2">                    @rownum := @rownum + 1 AS rank</span><span class="se">\</span>
<span class="s2">                        FROM Household, (SELECT @rownum := 0) r</span><span class="se">\</span>
<span class="s2">                        WHERE </span><span class="si">%s</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    ) `selection` WHERE idHousehold = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Criterium&#39;</span><span class="p">],</span> <span class="n">HouseholdID</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">nextHH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># get the next hh matching the modus criteria</span>
        <span class="k">global</span> <span class="n">Screen</span>
        <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getHH</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">prevHH</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="c1"># get the next hh matching the modus criteria</span>
        <span class="k">global</span> <span class="n">Screen</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getHH</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getHH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set householdID to indexed household and show</span>
        <span class="k">global</span> <span class="n">householdID</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idHousehold FROM Household WHERE </span><span class="si">%s</span><span class="s2"> LIMIT </span><span class="si">%s</span><span class="s2">,1;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Criterium&#39;</span><span class="p">],</span> <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Index&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">householdID</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;idHousehold&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">householdID</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

    <span class="k">def</span> <span class="nf">getScreens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Screen</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span>      <span class="s1">&#39;Home&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span> <span class="s1">&#39;status &gt;=0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span>     <span class="s1">&#39;No date yet&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span> <span class="s1">&#39;status = 1&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Email dates&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showHouseholds</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Select&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Prev&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Next&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;2&#39;</span><span class="p">:</span>   <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span>      <span class="s1">&#39;Future&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span> <span class="s1">&#39;date_choice &gt; CURDATE()&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Email alternative dates&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showHouseholds</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Select&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Prev&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Next&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span>      <span class="s1">&#39;Upcoming&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span> <span class="s1">&#39;status &lt; 4 AND date_choice &gt;= CURDATE() AND date_choice &lt; CURDATE() + INTERVAL &quot;21&quot; DAY ORDER BY date_choice ASC&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;confirm&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span>     <span class="s2">&quot;Email to confirm&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showHouseholds</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Select&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Prev&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Next&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirmed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span>    <span class="s1">&#39;status = 4 ORDER BY date_choice,idHousehold ASC&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviceConfig</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Device config&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;sent&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Email parcel sent&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showHouseholds</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Select Household&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Prev&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Next&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Issued&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span> <span class="s1">&#39;status = 5 ORDER BY date_choice ASC&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Email new dates&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;request_return&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Email return reminder&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showHouseholds</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Select&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Prev&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Next&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Overdue&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span> <span class="s1">&#39;status = 5 AND date_choice &lt; CURDATE() - INTERVAL &quot;21&quot; DAY ORDER BY date_choice ASC&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;request_return&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Email dates&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showHouseholds</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Select&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Prev&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Next&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Processed&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Criterium&#39;</span><span class="p">:</span> <span class="s1">&#39;status &gt; 5 ORDER BY date_choice DESC&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Household&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
                        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Email graph&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">showHouseholds</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Select&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Prev&quot;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextHH</span><span class="p">,</span>
                        <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s2">&quot;Next&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Screen</span>

    <span class="k">def</span> <span class="nf">setMainMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Show main text</span>
        <span class="n">mainScreenText</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMenuText</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">mainScreenText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">mainScreenText</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

        <span class="c1"># Show top status bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">=</span> <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;METER - </span><span class="si">%s</span><span class="s2"> - (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span><span class="p">,</span> <span class="n">getHost</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus1</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

        <span class="c1"># Show permanent commands in bottom status line</span>
        <span class="n">commandStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ActionKey</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">MasterKeysLabels</span><span class="p">):</span>
            <span class="n">commandStr</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">   [</span><span class="si">%s</span><span class="s2">]</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandStr</span><span class="p">,</span> <span class="n">ActionKey</span><span class="p">,</span> <span class="n">MasterKeysLabels</span><span class="p">[</span><span class="n">ActionKey</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;Commands:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">commandStr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus2</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">show_Tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">=</span> <span class="s1">&#39;Tables&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_tables</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list_household</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s2">&quot;Household&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s2">&quot;Meta&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list_contacts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_selected_data</span><span class="p">(</span><span class="s2">&quot;Contact&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_EditContact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;EditContact&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_EditHousehold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;EditHousehold&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">IgnoreForNow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">toggleDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">toggleDatabase</span><span class="p">()</span>
        <span class="n">MeterApp</span><span class="o">.</span><span class="n">_Forms</span><span class="p">[</span><span class="s1">&#39;MAIN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setMainMenu</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_contact</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;NewContact&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">afterEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">editing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchForm</span><span class="p">(</span><span class="s1">&#39;NewContact&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">display_selected_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displayModus</span><span class="p">):</span>
        <span class="c1"># pull SQL data and display                     #display_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">=</span> <span class="n">displayModus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;METER &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">+</span> <span class="s2">&quot; selection&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">displayModus</span> <span class="o">==</span> <span class="s2">&quot;Contact&quot;</span><span class="p">):</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM Contact&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">displayModus</span> <span class="o">==</span> <span class="s2">&quot;Households&quot;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;</span><span class="si">{:&lt;8}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;HH ID&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="si">{:&lt;7}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Status&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="si">{:&lt;20}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="si">{:&lt;3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">+</span>
                <span class="s2">&quot;</span><span class="si">{:&lt;25}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Comment&#39;</span><span class="p">)]</span>

            <span class="k">global</span> <span class="n">ScreenKey</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;idHousehold, timestamp, Contact_idContact, date_choice, CONVERT(comment USING utf8), status&#39;</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="n">fields</span> <span class="o">+</span> <span class="s2">&quot; FROM Household WHERE &quot;</span> <span class="o">+</span> <span class="n">Screen</span><span class="p">[</span><span class="n">ScreenKey</span><span class="p">][</span><span class="s1">&#39;Criterium&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
            <span class="c1"># executeSQL(sqlq)</span>
            <span class="n">hh_result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hh</span> <span class="ow">in</span> <span class="n">hh_result</span><span class="p">:</span>
                <span class="n">thisHHid</span>      <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">[</span><span class="s1">&#39;idHousehold&#39;</span><span class="p">])</span>
                <span class="n">thisContact</span>   <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">[</span><span class="s1">&#39;Contact_idContact&#39;</span><span class="p">])</span>
                <span class="n">thisDate</span>      <span class="o">=</span> <span class="n">getDateChoice</span><span class="p">(</span><span class="n">thisHHid</span><span class="p">)</span>
                <span class="n">thisComment</span>   <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">[</span><span class="s1">&#39;CONVERT(comment USING utf8)&#39;</span><span class="p">])</span>
                <span class="n">thisStatus</span>    <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hh</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="s2">&quot;</span><span class="si">{:&lt;7}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thisHHid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
                    <span class="s2">&quot;</span><span class="si">{:&lt;7}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thisStatus</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="si">{:&lt;20}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">getNameOfContact</span><span class="p">(</span><span class="n">thisContact</span><span class="p">))</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thisDate</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="si">{:&lt;3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">getParticipantCount</span><span class="p">(</span><span class="n">thisHHid</span><span class="p">)))</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="si">{:&lt;25}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thisComment</span><span class="p">)]</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">displayModus</span> <span class="o">==</span> <span class="s2">&quot;Household&quot;</span><span class="p">):</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT idHousehold FROM Household WHERE Contact_idContact = &#39;&quot;</span> <span class="o">+</span> <span class="n">contactID</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>

        <span class="c1"># result is populated, now display result</span>
        <span class="n">displayList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">displayModus</span> <span class="o">==</span> <span class="s2">&quot;Contact&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>

                <span class="n">keys</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
                <span class="n">displayList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formated_any</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">displayModus</span> <span class="o">==</span> <span class="s2">&quot;DataType&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">displayList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formated_two</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="c1"># displayList.append(self.formated_any(items))</span>
                <span class="n">displayList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="c1"># update display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">displayList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># XXX testj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus1</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

        <span class="n">commit</span><span class="p">()</span>
        <span class="c1"># global dbConnection</span>
        <span class="c1"># dbConnection.commit()</span>
        <span class="c1"># self.wStatus2.display()</span>

    <span class="k">def</span> <span class="nf">formated_any</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tupelItems</span><span class="p">):</span>
        <span class="n">returnString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tupelItems</span><span class="p">:</span>
            <span class="n">returnString</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="se">\t\t</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">returnString</span>

    <span class="k">def</span> <span class="nf">formated_two</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vl</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">display_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span> <span class="o">=</span> <span class="s1">&#39;Tables&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wStatus1</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;METER &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">myStatus</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SHOW TABLES&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">displayList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">displayList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;Tables_in_Meter&#39;</span><span class="p">])</span>

        <span class="c1"># self.wMain.values = displayList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">displayList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># XXX testj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wMain</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
        <span class="c1"># self.wMain.values = self.formated_word(result)</span>
        <span class="c1"># return result</span>

    <span class="k">def</span> <span class="nf">exit_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">widget_proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">cursor</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">setNextForm</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">switchFormNow</span><span class="p">()</span></div>


<div class="viewcode-block" id="editContactForm"><a class="viewcode-back" href="../README.html#interface.editContactForm">[docs]</a><span class="k">class</span> <span class="nc">editContactForm</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; gets fields from database, collects new entries &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">beforeEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SHOW columns from Contact;&quot;</span>
        <span class="n">tabledata</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactID</span> <span class="o">=</span> <span class="n">getContact</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from Contact WHERE idContact = </span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">contactID</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">tabledata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">TitleText</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;Field&#39;</span><span class="p">],</span>
                                      <span class="n">value</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;Field&#39;</span><span class="p">]]))</span>

    <span class="k">def</span> <span class="nf">afterEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="p">)):</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Contact SET `</span><span class="si">%s</span><span class="s2">` = &#39;</span><span class="si">%s</span><span class="s2">&#39; WHERE idContact = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>\
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">contactID</span><span class="p">)</span>
            <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">setNextFormPrevious</span><span class="p">()</span></div>


<div class="viewcode-block" id="editHouseholdForm"><a class="viewcode-back" href="../README.html#interface.editHouseholdForm">[docs]</a><span class="k">class</span> <span class="nc">editHouseholdForm</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; EditHousehold - Shows all entries for editing &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">beforeEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SHOW columns from Household;&quot;</span>
        <span class="n">tabledata</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from Household WHERE idHousehold = </span><span class="si">%s</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="n">householdID</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contactData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">tabledata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">TitleText</span><span class="p">,</span>
                                             <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;Field&#39;</span><span class="p">],</span>
                                             <span class="n">value</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;Field&#39;</span><span class="p">]]))</span>

    <span class="k">def</span> <span class="nf">afterEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="p">)):</span>
            <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Household SET `</span><span class="si">%s</span><span class="s2">` = &#39;</span><span class="si">%s</span><span class="s2">&#39; WHERE idHousehold = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>\
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">contactData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                 <span class="n">householdID</span><span class="p">)</span>
            <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">setNextFormPrevious</span><span class="p">()</span></div>


<div class="viewcode-block" id="newContactForm"><a class="viewcode-back" href="../README.html#interface.newContactForm">[docs]</a><span class="k">class</span> <span class="nc">newContactForm</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; gets fields from database, collects new entries &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get Household fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ColumnName</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ColumnEntry</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">beforeEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;SHOW columns from Contact;&quot;</span>
        <span class="n">tabledata</span> <span class="o">=</span> <span class="n">getSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">tabledata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ColumnName</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;Field&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ColumnName</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>       <span class="c1"># remove &#39;recorded&#39; field (auto completed)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ColumnName</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ColumnEntry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">TitleText</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ColumnName</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
        <span class="c1"># self.ColumnName.pop(0)   # to leave out the ID column</span>
        <span class="c1"># cursor.close()</span>

    <span class="k">def</span> <span class="nf">afterEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">contactID</span>
        <span class="k">global</span> <span class="n">householdID</span>

        <span class="c1"># combine all column names into comma separated string with ``</span>
        <span class="n">sqlColumnString</span> <span class="o">=</span> <span class="s2">&quot;`&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ColumnName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;`&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ColumnName</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">sqlColumnString</span> <span class="o">=</span> <span class="n">sqlColumnString</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;,`&quot;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s2">&quot;`&quot;</span><span class="p">)</span>

        <span class="n">sqlEntryString</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ColumnEntry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ColumnEntry</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">sqlEntryString</span> <span class="o">=</span> <span class="n">sqlEntryString</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;,&#39;&quot;</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># create contact</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO `Contact`(&quot;</span> <span class="o">+</span> <span class="n">sqlColumnString</span> <span class="o">+</span> <span class="s2">&quot;) </span><span class="se">\</span>
<span class="s2">            VALUES (&quot;</span> <span class="o">+</span> <span class="n">sqlEntryString</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="n">contactID</span> <span class="o">=</span> <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">commit</span><span class="p">()</span>

        <span class="c1"># create household</span>
        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO `Household`(Contact_idContact, security_code) </span><span class="se">\</span>
<span class="s2">            VALUES (</span><span class="si">%s</span><span class="s2">, 123);&quot;</span> <span class="o">%</span> <span class="n">contactID</span>
        <span class="n">householdID</span> <span class="o">=</span> <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">setNextFormPrevious</span><span class="p">()</span></div>


<div class="viewcode-block" id="metaFileInformation"><a class="viewcode-back" href="../README.html#interface.metaFileInformation">[docs]</a><span class="k">class</span> <span class="nc">metaFileInformation</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The MetaForm &quot;&quot;&quot;</span>
    <span class="c1"># display all .meta files in /METER/</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_fileList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectIndex</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metaIDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collectionDate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">displayString</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_Index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_Counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_contactID</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_collectionDate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_dataType</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_duration</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject_displayString</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FileSelection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">TitleMultiSelect</span><span class="p">,</span> <span class="n">max_height</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Which files should be uploaded?&quot;</span><span class="p">,</span>
                                      <span class="n">scroll_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FileRejection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">TitleMultiSelect</span><span class="p">,</span> <span class="n">max_height</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s2">&quot;These files will be deleted (uncheck to save them)?&quot;</span><span class="p">,</span>
                                      <span class="n">scroll_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">beforeEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FileSelection</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="c1"># set up file names</span>
        <span class="k">global</span> <span class="n">filePath</span>

        <span class="c1"># 7 Nov 2016 XXX allCSVfiles = filePath + &#39;*.csv&#39;</span>
        <span class="c1"># BUG: empty list causes a &quot;-1&quot; entry to show next time...</span>

        <span class="n">allCSVfiles</span> <span class="o">=</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s1">&#39;METER/*.csv&#39;</span>
        <span class="n">allJSONfiles</span> <span class="o">=</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s1">&#39;METER/*.json&#39;</span>
        <span class="n">CSVfileList</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">allCSVfiles</span><span class="p">)</span>
        <span class="n">CSVfileList</span> <span class="o">=</span> <span class="n">CSVfileList</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">allJSONfiles</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">DataFile</span> <span class="ow">in</span> <span class="n">CSVfileList</span><span class="p">:</span>
            <span class="n">recordsInFile</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">DataFile</span><span class="p">))</span>
            <span class="n">thisFileName</span> <span class="o">=</span> <span class="n">DataFile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">thisFileName</span> <span class="o">=</span> <span class="n">thisFileName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">recordsInFile</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span> <span class="o">+</span> <span class="n">thisFileName</span> <span class="o">+</span> <span class="s1">&#39;.meta ~/.Trash/&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span> <span class="o">+</span> <span class="n">thisFileName</span> <span class="o">+</span> <span class="s1">&#39;.csv ~/.Trash/&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">recordsInFile</span> <span class="o">&gt;</span> <span class="mi">80000</span><span class="p">):</span>
                <span class="k">global</span> <span class="n">householdID</span>
                <span class="c1"># only full 24 hour recordings are of interest</span>
                <span class="c1"># (that would be 86400 seconds)</span>

                <span class="c1"># the split() takes the Watt column after first &#39;,&#39; before &#39;\n&#39;</span>
                <span class="n">meanPower</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">DataFile</span><span class="p">))</span> <span class="o">/</span> <span class="n">recordsInFile</span>

                <span class="n">thisMeta</span> <span class="o">=</span> <span class="n">getMetaData</span><span class="p">(</span><span class="n">thisFileName</span> <span class="o">+</span> <span class="s1">&#39;.meta&#39;</span><span class="p">,</span> <span class="s2">&quot;Meta ID&quot;</span><span class="p">)</span>
                <span class="n">householdID</span> <span class="o">=</span> <span class="n">getHouseholdForMeta</span><span class="p">(</span><span class="n">thisMeta</span><span class="p">)</span>
                <span class="n">thisDateChoice</span> <span class="o">=</span> <span class="n">getDateChoice</span><span class="p">(</span><span class="n">householdID</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectIndex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisFileName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metaIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisMeta</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">collectionDate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getMetaData</span><span class="p">(</span><span class="n">thisFileName</span> <span class="o">+</span> <span class="s1">&#39;.meta&#39;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getMetaData</span><span class="p">(</span><span class="n">thisFileName</span> <span class="o">+</span> <span class="s1">&#39;.meta&#39;</span><span class="p">,</span> <span class="s2">&quot;Data type&quot;</span><span class="p">))</span>
                <span class="n">thisDuration</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">recordsInFile</span> <span class="o">/</span> <span class="mf">3600.0</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">displayString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. ID: &#39;</span> <span class="o">+</span>
                                     <span class="n">thisMeta</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                     <span class="s1">&#39; on &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectionDate</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">thisDateChoice</span> <span class="o">+</span> <span class="s1">&#39;) for &#39;</span> <span class="o">+</span>
                                     <span class="n">thisDuration</span> <span class="o">+</span> <span class="s1">&#39; h (&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">meanPower</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;W)&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;act&#39;</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectIndex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisFileName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metaIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">DataFile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>        <span class="c1"># filename is metaID+&#39;_act.csv&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">collectionDate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getDateOfFirstEntry</span><span class="p">(</span><span class="n">DataFile</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>           <span class="c1"># take date from first entry in column 1 (2nd col)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recordsInFile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. ID: &#39;</span> <span class="o">+</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">metaIDs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                     <span class="s1">&#39; with &#39;</span> <span class="o">+</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; records&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;ind&#39;</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectIndex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisFileName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metaIDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">DataFile</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>        <span class="c1"># filename is metaID+&#39;_ind.csv&#39;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">collectionDate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getDateOfFirstEntry</span><span class="p">(</span><span class="n">DataFile</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>           <span class="c1"># take date from first entry in column 0 (1nd col)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recordsInFile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">displayString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;. ID: &#39;</span> <span class="o">+</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">metaIDs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                     <span class="s1">&#39; with &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; records&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selectCounter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;config&#39;</span> <span class="ow">in</span> <span class="n">DataFile</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_Index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reject_Counter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisFileName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_contactID</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getMetaData</span><span class="p">(</span><span class="n">thisFileName</span> <span class="o">+</span>
                                        <span class="s1">&#39;.meta&#39;</span><span class="p">,</span> <span class="s2">&quot;Contact ID&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_collectionDate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getMetaData</span><span class="p">(</span><span class="n">thisFileName</span> <span class="o">+</span>
                                        <span class="s1">&#39;.meta&#39;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_dataType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getMetaData</span><span class="p">(</span><span class="n">thisFileName</span> <span class="o">+</span>
                                        <span class="s1">&#39;.meta&#39;</span><span class="p">,</span> <span class="s2">&quot;Data type&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">recordsInFile</span> <span class="o">/</span> <span class="mf">3600.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_displayString</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reject_Counter</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="se">\t</span><span class="s1"> ID: &#39;</span> <span class="o">+</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">reject_contactID</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">reject_dataType</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; on &#39;</span> <span class="o">+</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">reject_collectionDate</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                        <span class="s1">&#39; for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reject_duration</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                                        <span class="s1">&#39; hours&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject_Counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FileSelection</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displayString</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FileSelection</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectIndex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FileRejection</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_displayString</span>

    <span class="k">def</span> <span class="nf">afterEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FileSelection</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">uploadDataFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataType</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaIDs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectionDate</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>   <span class="c1"># insert to database</span>

        <span class="k">for</span> <span class="n">FileIndex</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FileRejection</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>                                      <span class="c1"># delete all other files</span>
            <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_fileList</span><span class="p">[</span><span class="n">FileIndex</span><span class="p">]</span> <span class="o">+</span>
                 <span class="s1">&#39;.meta ~/.Trash/&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_fileList</span><span class="p">[</span><span class="n">FileIndex</span><span class="p">]</span> <span class="o">+</span>
                 <span class="s1">&#39;.csv ~/.Trash/&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># tidy up any left over files</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span> <span class="o">+</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s1">&#39;/METER/*.csv &#39;</span> <span class="o">+</span> <span class="n">archivePath</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span> <span class="o">+</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s1">&#39;/METER/*.meta &#39;</span> <span class="o">+</span> <span class="n">archivePath</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">call</span><span class="p">(</span><span class="s1">&#39;mv &#39;</span> <span class="o">+</span> <span class="n">filePath</span> <span class="o">+</span> <span class="s1">&#39;/METER/*_act.json &#39;</span> <span class="o">+</span> <span class="n">archivePath</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># switch to &quot;Processed&quot; and display the most recent addition</span>
        <span class="k">global</span> <span class="n">ScreenKey</span>
        <span class="n">ScreenKey</span> <span class="o">=</span> <span class="s2">&quot;7&quot;</span>  <span class="c1"># display as &quot;Processed&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">setNextFormPrevious</span><span class="p">()</span></div>


<div class="viewcode-block" id="snEntry"><a class="viewcode-back" href="../README.html#interface.snEntry">[docs]</a><span class="k">class</span> <span class="nc">snEntry</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">ActionPopup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; pops up to collect a serial number &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># will be assigned externally by device_config()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">TitleText</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Serial number for </span><span class="si">%s</span><span class="s2">:&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">beforeEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sn</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span>
        <span class="n">message</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sn</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">snFilePath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sn</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">callShell</span><span class="p">(</span><span class="s2">&quot;adb push </span><span class="si">%s</span><span class="s2"> /sdcard/METER/&quot;</span> <span class="o">%</span> <span class="n">snFilePath</span><span class="p">)</span>

        <span class="c1"># XXX EXPERIMENTAL - could it have been this change that makes phones not wake up after 7 days?</span>
        <span class="c1"># callShell(&#39;adb shell reboot -p&#39;)</span>
        <span class="c1"># call(&#39;adb shell reboot -p&#39;, shell=True)</span>

        <span class="n">sqlq</span> <span class="o">=</span> <span class="s2">&quot;UPDATE Meta SET SerialNumber = &#39;</span><span class="si">%s</span><span class="s2">&#39; WHERE idMeta = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sn</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="n">message</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">executeSQL</span><span class="p">(</span><span class="n">sqlq</span><span class="p">)</span>
        <span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">afterEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentApp</span><span class="o">.</span><span class="n">setNextFormPrevious</span><span class="p">()</span></div>


<div class="viewcode-block" id="MeterTheme"><a class="viewcode-back" href="../README.html#interface.MeterTheme">[docs]</a><span class="k">class</span> <span class="nc">MeterTheme</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">ThemeManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; defines colours &quot;&quot;&quot;</span>
    <span class="n">default_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span>      <span class="s1">&#39;WHITE_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FORMDEFAULT&#39;</span><span class="p">:</span>  <span class="s1">&#39;GREEN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NO_EDIT&#39;</span><span class="p">:</span>      <span class="s1">&#39;BLUE_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;STANDOUT&#39;</span><span class="p">:</span>     <span class="s1">&#39;CYAN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CURSOR&#39;</span><span class="p">:</span>       <span class="s1">&#39;GREEN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CURSOR_INVERSE&#39;</span><span class="p">:</span> <span class="s1">&#39;BLACK_WHITE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LABEL&#39;</span><span class="p">:</span>        <span class="s1">&#39;GREEN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;LABELBOLD&#39;</span><span class="p">:</span>    <span class="s1">&#39;WHITE_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CONTROL&#39;</span><span class="p">:</span>      <span class="s1">&#39;YELLOW_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;IMPORTANT&#39;</span><span class="p">:</span>    <span class="s1">&#39;GREEN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SAFE&#39;</span><span class="p">:</span>         <span class="s1">&#39;GREEN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WARNING&#39;</span><span class="p">:</span>      <span class="s1">&#39;YELLOW_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DANGER&#39;</span><span class="p">:</span>       <span class="s1">&#39;RED_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CRITICAL&#39;</span><span class="p">:</span>     <span class="s1">&#39;BLACK_RED&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GOOD&#39;</span><span class="p">:</span>         <span class="s1">&#39;GREEN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GOODHL&#39;</span><span class="p">:</span>       <span class="s1">&#39;GREEN_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;VERYGOOD&#39;</span><span class="p">:</span>     <span class="s1">&#39;BLACK_GREEN&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CAUTION&#39;</span><span class="p">:</span>      <span class="s1">&#39;YELLOW_BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CAUTIONHL&#39;</span><span class="p">:</span>    <span class="s1">&#39;BLACK_YELLOW&#39;</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="MeterForms"><a class="viewcode-back" href="../README.html#interface.MeterForms">[docs]</a><span class="k">class</span> <span class="nc">MeterForms</span><span class="p">(</span><span class="n">nps</span><span class="o">.</span><span class="n">NPSAppManaged</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; add Forms to the app &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">onStart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># nps.setTheme(nps.Themes.ColorfulTheme)</span>
        <span class="n">nps</span><span class="o">.</span><span class="n">setTheme</span><span class="p">(</span><span class="n">MeterTheme</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span><span class="s1">&#39;MAIN&#39;</span><span class="p">,</span> <span class="n">MeterMain</span><span class="p">,</span> <span class="n">lines</span><span class="o">=</span><span class="mi">36</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span><span class="s1">&#39;NewContact&#39;</span><span class="p">,</span> <span class="n">newContactForm</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;New Contact&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span><span class="s1">&#39;EditContact&#39;</span><span class="p">,</span> <span class="n">editContactForm</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Edit Contact&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span><span class="s1">&#39;EditHousehold&#39;</span><span class="p">,</span> <span class="n">editHouseholdForm</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Edit Household&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span><span class="s1">&#39;MetaForm&#39;</span><span class="p">,</span> <span class="n">metaFileInformation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Meta Data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snForm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addForm</span><span class="p">(</span><span class="s1">&#39;snEntry&#39;</span><span class="p">,</span> <span class="n">snEntry</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;New Serial Number&#39;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; start the app &quot;&quot;&quot;</span>
    <span class="n">MeterApp</span> <span class="o">=</span> <span class="n">MeterForms</span><span class="p">()</span>
    <span class="n">MeterApp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">exit</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../README.html">MeterInterface beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Phil Grunewald.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>